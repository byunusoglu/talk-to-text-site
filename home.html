<!-- home.html ‚Äî Post-signup Homepage (StoryBuds) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Home ‚Äî StoryBuds</title>

  <!-- Fonts + Shared CSS/JS -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Inter:wght@400;600&family=Alegreya:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="script.js"></script>

  <style>
    /* ====== Local styles for "My Stories" (kept self-contained) ====== */
    .stories-list {
      display: grid;
      gap: 12px;
      max-width: 820px;
      margin: 0 auto 16px;
      padding: 0;
      list-style: none;
    }
    .story-item {
      display: grid;
      grid-template-columns: 120px 1fr auto;
      align-items: center;
      gap: 12px;
      background: #fff;
      border: 1px solid #eee9fb;
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 10px;
      position: relative;
    }
    .story-cover {
      width: 120px;
      height: 86px;
      border-radius: 12px;
      overflow: hidden;
      background: linear-gradient(120deg, var(--bg1, #fffaf3), var(--bg2, #f7ebf7));
      border: 1px solid #eee9fb;
    }
    .story-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .story-info h3 {
      margin: 0 0 6px;
      color: var(--plum-dark);
      font-size: 18px;
      font-family: 'Nunito', sans-serif;
    }
    .story-meta {
      margin: 0 0 10px;
      color: #6b6479;
      font-size: 13px;
    }
    .btn.small { padding: 8px 14px; font-size: 14px; border-radius: 999px; }
    .stories-empty {
      max-width: 820px;
      margin: 0 auto 16px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #eee9fb;
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      color: #3a3450;
    }

    /* ===== NEW: Feature Enhancements ===== */
    
    /* Favorites button */
    .favorite-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      transition: transform 0.2s;
      line-height: 1;
    }
    .favorite-btn:hover { transform: scale(1.15); }
    .favorite-btn.active { animation: heartBeat 0.3s ease; }
    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }

    /* Collections dropdown */
    .collection-selector {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
      max-width: 820px;
      margin-left: auto;
      margin-right: auto;
    }
    .collection-selector select {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #eee9fb;
      border-radius: 12px;
      background: white;
      color: var(--plum-dark);
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
    }
    .collection-selector .btn { white-space: nowrap; }

    /* Recent Activity */
    .recent-activity {
      max-width: 820px;
      margin: 0 auto 24px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #eee9fb;
      border-radius: 14px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .recent-activity h3 {
      margin: 0 0 12px;
      color: var(--plum-dark);
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .recent-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .recent-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f9f7fc;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .recent-item:hover { background: #f3f0fa; }
    .recent-item-title { color: var(--plum-dark); font-weight: 600; font-size: 14px; }
    .recent-item-time { color: #6b6479; font-size: 12px; }

    /* Recommendations Carousel */
    .recommendations {
      max-width: 820px;
      margin: 0 auto 24px;
      background: linear-gradient(135deg, rgba(142,68,236,0.08), rgba(182,122,243,0.08));
      border: 1px solid #eee9fb;
      border-radius: 14px;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .recommendations h3 {
      margin: 0 0 16px;
      color: var(--plum-dark);
      font-size: 18px;
      text-align: center;
    }
    .rec-carousel {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      padding-bottom: 8px;
      scrollbar-width: thin;
      scrollbar-color: var(--plum) #f3f0fa;
    }
    .rec-carousel::-webkit-scrollbar { height: 6px; }
    .rec-carousel::-webkit-scrollbar-track { background: #f3f0fa; border-radius: 3px; }
    .rec-carousel::-webkit-scrollbar-thumb { background: var(--plum); border-radius: 3px; }
    .rec-card {
      min-width: 200px;
      background: white;
      border-radius: 12px;
      padding: 16px;
      scroll-snap-align: start;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid #eee9fb;
    }
    .rec-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(142,68,236,0.15);
    }
    .rec-card-emoji { font-size: 32px; margin-bottom: 8px; }
    .rec-card-title { color: var(--plum-dark); font-weight: 700; font-size: 15px; margin-bottom: 4px; }
    .rec-card-desc { color: #6b6479; font-size: 13px; line-height: 1.4; }

    /* Usage Progress Bars */
    .usage-bar {
      margin: 12px 0;
      background: rgba(142,68,236,0.1);
      border-radius: 999px;
      height: 8px;
      overflow: hidden;
      position: relative;
    }
    .usage-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #8E44EC, #B67AF3);
      border-radius: 999px;
      transition: width 0.5s ease;
    }
    .usage-text {
      font-size: 12px;
      color: #6b6479;
      margin-top: 4px;
      text-align: center;
    }

    /* Enhanced Testimonials */
    .testimonial-carousel {
      position: relative;
      max-width: 700px;
      margin: 0 auto;
    }
    .testimonial {
      background: rgba(255,255,255,0.9);
      border: 1px solid #eee9fb;
      border-radius: 18px;
      padding: 24px;
      box-shadow: var(--shadow);
      margin: 0;
    }
    .testimonial-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .testimonial-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--plum), #B67AF3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 20px;
    }
    .testimonial-info { flex: 1; text-align: left; }
    .testimonial-name { font-weight: 700; color: var(--plum-dark); margin: 0; }
    .testimonial-role { font-size: 13px; color: #6b6479; margin: 2px 0 0; }
    .testimonial-stars {
      color: #FFB800;
      font-size: 16px;
      letter-spacing: 2px;
    }
    .t-quote {
      margin: 0;
      font-size: 16px;
      line-height: 1.6;
      color: var(--text);
      font-style: italic;
    }
    .carousel-nav {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }
    .carousel-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #d4c5f4;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      padding: 0;
    }
    .carousel-dot.active {
      background: var(--plum);
      width: 24px;
      border-radius: 5px;
    }

    /* Story badge for collections */
    .story-badge {
      display: inline-block;
      background: rgba(142,68,236,0.1);
      color: var(--plum-dark);
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      margin-left: 6px;
    }

    /* Keep your existing plan & hero helpers from the previous version */
    .plans-grid { 
      display: grid; 
      grid-template-columns: repeat(4, minmax(0, 1fr)); 
      gap: 12px; 
      max-width: 1200px; 
      margin: 0 auto; 
    }
    @media (max-width: 1100px) { .plans-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .plans-grid { grid-template-columns: 1fr; } }

    .plan-card { 
      background: rgba(255,255,255,0.9);
      border: 1px solid #eee9fb;
      border-radius: 18px;
      box-shadow: var(--shadow);
      text-align: left;
      padding: 16px;
      position: relative;
      overflow: hidden;
    }
    .plan-card h3 { margin: 0 0 8px; color: var(--plum-dark); font-size: 18px; }
    .plan-card .price { font-weight: 800; color: var(--plum-dark); margin-bottom: 6px; font-size: 15px; }
    .plan-card ul { margin: 10px 0 14px; padding-left: 16px; font-size: 13px; }
    .plan-card li { margin: 5px 0; color: #3a3450; }
    .plan-card .btn { width: 100%; font-size: 13px; padding: 10px 16px; }

    .plan-card.basic  { background: #ffffff; }
    .plan-card.plus   { background: linear-gradient(180deg, rgba(243,240,250,.6), rgba(233,220,255,.6)); }
    .plan-card.premium { 
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(246,241,255,0.9));
      box-shadow: 0 16px 30px rgba(142,68,236,0.18);
    }
    .plan-card.infinite {
      background: linear-gradient(180deg, rgba(255,215,0,0.1), rgba(255,165,0,0.15));
      border: 2px solid rgba(255,165,0,0.3);
    }

    .ribbon {
      position: absolute; top: 12px; right: -32px;
      background: linear-gradient(135deg, #8E44EC, #B67AF3);
      color: #fff; font-weight: 800; font-size: 12px;
      padding: 8px 42px; transform: rotate(12deg);
      box-shadow: var(--shadow);
    }

    .storybud-wrap {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 16px;
      max-width: 980px;
      margin: 0 auto;
      text-align: left;
      align-items: center;
    }
    .storybud-media {
      border-radius: 18px; overflow: hidden; border: 1px solid #eee9fb;
      box-shadow: var(--shadow); background: #fff;
      height: min(40vh, 340px); display: grid; place-items: center;
    }
    .storybud-media img { width: 100%; height: 100%; object-fit: cover; }
    .storybud-copy h3 { margin: 0 0 8px; color: var(--plum-dark); font-size: 22px; }
    .storybud-copy p { margin: 6px 0 10px; color: #3a3450; }
    .storybud-perk { display: inline-block; margin-top: 6px; }
    @media (max-width: 900px) {
      .storybud-wrap { grid-template-columns: 1fr; }
      .storybud-media { height: 240px; }
    }

    .hero-premium .btn + .hint { color: rgba(255,255,255,0.9); margin-top: 10px; }
  </style>
</head>
<body class="fade-in">

  <!-- Topbar (same as other pages) -->
  <header class="topbar">
    <a href="index.html" class="logo">
      <span class="logo-badge">
        <img src="logo.png" alt="StoryBuds logo" />
      </span>
    </a>

    <div class="top-actions">
      <button class="hamburger" id="menuBtn" aria-label="Menu">‚ò∞</button>
    </div>

    <nav id="menu" class="menu hidden" aria-label="Main navigation">
      <a href="home.html" aria-current="page">Home</a>
      <a href="create.html">Create Stories</a>
      <a href="#">My Profile</a>
    </nav>
  </header>

  <!-- HERO: Personal welcome + free-story CTA -->
  <section class="hero-premium fade-in">
    <div class="hero-bg">
      <img src="familyanimation.png" alt="Welcome to your story world" />
    </div>
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h1 id="welcomeTitle">Welcome to your story world üåô</h1>
      <p id="welcomeDesc">Your first magical story is ready to read tonight.</p>
      <button class="btn" id="openStoryBtn">Open your free story</button>
      <div class="hint">Want more voices and stories? See plans below.</div>
    </div>
  </section>

  <!-- ===== NEW: MY STORIES (Library) ===== -->
  <section class="section fade-up" id="myStories">
    <h2>My Stories</h2>
    <p class="formats-sub">Continue your adventures or create a new one.</p>

    <!-- Recent Activity -->
    <div class="recent-activity" id="recentActivity" style="display:none;">
      <h3>üïê Recently Played</h3>
      <div class="recent-list" id="recentList">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Recommendations -->
    <div class="recommendations" id="recommendations">
      <h3>‚ú® Stories you might enjoy creating next</h3>
      <div class="rec-carousel" id="recCarousel">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Collection Selector -->
    <div class="collection-selector">
      <select id="collectionFilter">
        <option value="all">All Stories</option>
        <option value="favorites">‚≠ê Favorites</option>
        <option value="bedtime">üåô Bedtime</option>
        <option value="adventure">üó∫Ô∏è Adventure</option>
        <option value="educational">üìö Educational</option>
      </select>
      <button class="btn ghost small" id="manageCollectionsBtn">Manage</button>
    </div>

    <ul class="stories-list" id="storiesList">
      <!-- Populated by JS -->
    </ul>

    <button class="btn" id="createNewStoryBtn">‚ûï Create a New Story</button>
  </section>

  <!-- PLAN COMPARISON -->
  <section class="section fade-up" id="plans">
    <h2>Grow the magic</h2>
    <p class="formats-sub">Choose the plan that fits your family's bedtime rhythm.</p>

    <div class="plans-grid">
      <!-- Basic (Free) -->
      <article class="plan-card basic" data-plan="basic">
        <h3>Basic</h3>
        <div class="price">¬£0 / month</div>
        
        <!-- Usage tracking -->
        <div class="usage-bar">
          <div class="usage-bar-fill" id="freeStoriesBar" style="width: 0%"></div>
        </div>
        <div class="usage-text" id="freeStoriesText">Loading...</div>

        <div class="usage-bar">
          <div class="usage-bar-fill" id="imageStoriesBar" style="width: 0%"></div>
        </div>
        <div class="usage-text" id="imageStoriesText">Loading...</div>

        <div class="usage-bar">
          <div class="usage-bar-fill" id="freeVoicesBar" style="width: 0%"></div>
        </div>
        <div class="usage-text" id="freeVoicesText">Loading...</div>

        <ul>
          <li><b>10 text stories</b> / month</li>
          <li><b>1 image story</b> / month</li>
          <li><b>No voice cloning</b></li>
        </ul>
        <button class="btn ghost" disabled>Current plan</button>
      </article>

      <!-- Plus -->
      <article class="plan-card plus" data-plan="plus">
        <h3>Plus</h3>
        <div class="price">¬£4.99 / month</div>
        <ul>
          <li><b>50 text stories</b> / month</li>
          <li><b>20 image stories</b> / month</li>
          <li><b>5 voice clones</b></li>
          <li><b>Priority support</b></li>
        </ul>
        <button class="btn" data-upgrade="plus">Upgrade to Plus</button>
      </article>

      <!-- Premium -->
      <article class="plan-card premium" data-plan="premium">
        <div class="ribbon">‚≠ê Most loved</div>
        <h3>Premium</h3>
        <div class="price">¬£9.99 / month</div>
        <ul>
          <li><b>200 text stories</b> / month</li>
          <li><b>100 image stories</b> / month</li>
          <li><b>20 voice clones</b></li>
          <li><b>Priority support</b></li>
          <li><b>Advanced customization</b></li>
        </ul>
        <button class="btn" data-upgrade="premium">Go Premium</button>
      </article>

      <!-- Infinite -->
      <article class="plan-card infinite" data-plan="infinite">
        <h3>Infinite</h3>
        <div class="price">¬£19.99 / month</div>
        <ul>
          <li><b>Unlimited</b> text stories</li>
          <li><b>Unlimited</b> image stories</li>
          <li><b>Unlimited</b> voice clones</li>
          <li><b>Priority support</b></li>
          <li><b>Early access features</b></li>
        </ul>
        <button class="btn" data-upgrade="infinite">Go Infinite</button>
      </article>
    </div>
  </section>

  <!-- STORYBUD DEVICE CROSS-SELL -->
  <section class="section fade-up">
    <h2>Bring stories to life with StoryBud</h2>
    <p class="formats-sub">A magical storyteller that reads your child‚Äôs tales aloud ‚Äî with sounds, giggles, and love.</p>

    <div class="storybud-wrap">
      <div class="storybud-media">
        <img src="childsdreambanner.png" alt="StoryBud toy speaker playing bedtime stories" />
      </div>
      <div class="storybud-copy">
        <h3>StoryBud ‚Äî the bedtime storyteller</h3>
        <p>Just press play. Your child hears their own personalised adventures ‚Äî hands-free, screen-free.</p>
        <div class="pill storybud-perk">üéÅ Includes <b>3 months Premium</b> for free</div>
        <div style="margin-top:12px">
          <button class="btn" id="buyStoryBudBtn">Get StoryBud</button>
          <button class="btn ghost" id="learnStoryBudBtn">Learn more</button>
        </div>
      </div>
    </div>
  </section>

  <!-- TESTIMONIALS -->
    <!-- TESTIMONIALS -->
  <section class="section testimonials fade-up delay-1" id="testimonials" aria-label="What parents say">
    <div class="testimonial-carousel">
      <figure class="testimonial" id="currentTestimonial">
        <!-- Populated by JS -->
      </figure>
      <div class="carousel-nav" id="testimonialNav">
        <!-- Populated by JS -->
      </div>
    </div>
  </section>

  <footer>
    ¬© <span id="year"></span> StoryBuds
  </footer>

  <!-- Sticky CTA for mobile -->
  <a class="mobile-cta" id="mobileCta" href="#" aria-label="Upgrade plan">
    ‚ú® Upgrade to Pro ‚Äî ¬£3.99
  </a>

  <script>
  (function() {
    // Consider user "signed in" post-signup for routing smoothness (existing behavior)
    try { localStorage.setItem('yw_signed_in', '1'); } catch (e) {}

    // ========================================
    // CHECK FOR STORY GENERATION IN PROGRESS
    // ========================================
    const urlParams = new URLSearchParams(window.location.search);
    const generatingJobId = urlParams.get('generating');
    
    if (generatingJobId) {
      console.log('[home.html] Story generation in progress, jobId:', generatingJobId);
      showGenerationProgress(generatingJobId);
    }

    /**
     * Show generation progress modal and poll job
     */
    function showGenerationProgress(jobId) {
      // Create modal overlay
      const modal = document.createElement('div');
      modal.id = 'generationModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(58, 52, 80, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(8px);
      `;
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 20px;
          padding: 40px;
          max-width: 500px;
          width: 90%;
          text-align: center;
          box-shadow: 0 20px 60px rgba(142, 68, 236, 0.3);
        ">
          <div class="wait-dots" aria-hidden="true" style="margin-bottom: 24px;">
            <span></span><span></span><span></span>
          </div>
          <h2 style="color: var(--plum-dark); margin: 0 0 12px; font-size: 24px;">
            ‚ú® Creating Your Story
          </h2>
          <p id="generationStatus" style="color: #6b6479; margin: 0 0 20px; font-size: 16px;">
            Generating magical content...
          </p>
          <div style="
            background: rgba(142, 68, 236, 0.1);
            border-radius: 999px;
            height: 6px;
            overflow: hidden;
            margin-bottom: 12px;
          ">
            <div id="generationProgress" style="
              height: 100%;
              background: linear-gradient(90deg, var(--plum), #B67AF3);
              width: 0%;
              transition: width 0.5s ease;
            "></div>
          </div>
          <p style="color: #9a8fb5; font-size: 13px; margin: 0;">
            This usually takes 30-60 seconds
          </p>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Start polling
      const API_BASE = 'https://storyai-backend-production.up.railway.app/api/v1';
      let pollCount = 0;
      
      const updateProgress = (message, percent) => {
        const statusEl = document.getElementById('generationStatus');
        const progressEl = document.getElementById('generationProgress');
        if (statusEl) statusEl.textContent = message;
        if (progressEl) progressEl.style.width = percent + '%';
      };

      // Wait for script.js to load and expose the polling function
      const startPolling = () => {
        if (typeof window.pollJobUntilComplete !== 'function') {
          console.log('[home.html] Waiting for pollJobUntilComplete to be available...');
          updateProgress('Initializing story generation...', 5);
          setTimeout(startPolling, 100);
          return;
        }
        
        console.log('[home.html] pollJobUntilComplete is available, starting poll');
        
        // Import pollJobUntilComplete from script.js scope
        const cleanup = window.pollJobUntilComplete(jobId, {
          onProgress: ({ status, message, pollCount }) => {
            console.log('[Generation Progress]', status, message);
            
            let displayMessage = 'Generating magical content...';
            let percent = 20;
            
            if (status === 'processing') {
              if (message.includes('page')) {
                displayMessage = 'Creating story pages...';
                percent = 60;
              } else if (message.includes('image')) {
                displayMessage = 'Illustrating your story...';
                percent = 70;
              } else if (message.includes('audio')) {
                displayMessage = 'Adding voice narration...';
                percent = 85;
              } else {
                displayMessage = 'Weaving your story together...';
                percent = 40;
              }
            } else if (status === 'pending') {
              displayMessage = 'Preparing story generation...';
              percent = 10;
            }
            
            // Increment progress slightly with each poll
            percent = Math.min(95, percent + (pollCount * 2));
            
            updateProgress(displayMessage, percent);
          },
          
          onComplete: (storyData) => {
            console.log('[Generation Complete]', storyData);
            updateProgress('Story complete! üéâ', 100);
            
            // Store the story in sessionStorage for immediate viewing
            try {
              sessionStorage.setItem('yw_current_story', JSON.stringify(storyData));
              sessionStorage.setItem('yw_story_id', storyData.storyId);
            } catch (e) {
              console.error('Failed to store story:', e);
            }
            
            // Wait a moment then close modal and refresh stories
            setTimeout(() => {
              modal.remove();
              
              // Remove generating parameter from URL
              const newUrl = window.location.pathname;
              window.history.replaceState({}, '', newUrl);
              
              // Reload the stories list
              if (typeof loadMyStories === 'function') {
                loadMyStories();
              }
              
              // Show success message
              const successMsg = document.createElement('div');
              successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #4CAF50;
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-weight: 600;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideDown 0.3s ease;
              `;
              successMsg.textContent = `‚ú® "${storyData.title}" is ready!`;
              document.body.appendChild(successMsg);
              
              setTimeout(() => {
                successMsg.style.opacity = '0';
                successMsg.style.transition = 'opacity 0.3s';
                setTimeout(() => successMsg.remove(), 300);
              }, 4000);
              
            }, 1000);
          },
          
          onError: (error) => {
            console.error('[Generation Error]', error);
            
            // Check if it's a coin balance issue
            const errorMessage = error.message || '';
            const isInsufficientBalance = errorMessage.toLowerCase().includes('insufficient balance') || 
                                         errorMessage.toLowerCase().includes('coins');
            
            if (isInsufficientBalance) {
              updateProgress('Insufficient credits', 0);
              
              setTimeout(() => {
                modal.remove();
                
                // Show a more helpful message for insufficient balance
                const balanceMsg = document.createElement('div');
                balanceMsg.style.cssText = `
                  position: fixed;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  background: white;
                  padding: 32px;
                  border-radius: 16px;
                  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                  z-index: 10001;
                  max-width: 400px;
                  text-align: center;
                `;
                balanceMsg.innerHTML = `
                  <h3 style="margin: 0 0 12px; color: var(--plum-dark);">üí∞ Out of Credits</h3>
                  <p style="margin: 0 0 20px; color: #6b6479;">
                    You've used all your free story credits this month. 
                    Upgrade to continue creating unlimited stories!
                  </p>
                  <button class="btn" onclick="this.parentElement.remove(); window.location.href='home.html#plans';" style="width: 100%; margin-bottom: 8px;">
                    View Plans
                  </button>
                  <button class="btn ghost" onclick="this.parentElement.remove();" style="width: 100%;">
                    Close
                  </button>
                `;
                document.body.appendChild(balanceMsg);
                
                // Remove generating parameter from URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, '', newUrl);
              }, 1500);
            } else {
              updateProgress('Oops! Something went wrong', 0);
              
              setTimeout(() => {
                modal.remove();
                alert('Sorry, story generation failed: ' + errorMessage + '\n\nPlease try again.');
                
                // Remove generating parameter from URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, '', newUrl);
              }, 2000);
            }
          }
        });
        
        // Store cleanup function in case user navigates away
        window._storyGenerationCleanup = cleanup;
      };
      
      // Start the polling process
      startPolling();
    }

    // ========================================
    // DUMMY DATA & UTILITY FUNCTIONS
    // ========================================

    // Dummy testimonials with ratings and avatars
    const testimonials = [
      {
        name: "Elif",
        role: "Parent of 2",
        quote: "Bedtime became our favourite 10 minutes. She laughs at the whooosh and plip-plop bits.",
        rating: 5,
        avatar: "E"
      },
      {
        name: "James",
        role: "Father of twins",
        quote: "Personalised names make him light up. We finally look forward to the routine.",
        rating: 5,
        avatar: "J"
      },
      {
        name: "Ana",
        role: "Mother of 1",
        quote: "It feels like co-creating. The app listens while we talk, then the story appears. Magic.",
        rating: 5,
        avatar: "A"
      },
      {
        name: "Zeynep",
        role: "Parent of 3",
        quote: "The voices and sound effects are a delight. We upgraded after a week.",
        rating: 5,
        avatar: "Z"
      },
      {
        name: "Michael",
        role: "Single dad",
        quote: "My son asks for 'our special story time' every night now. Worth every penny!",
        rating: 5,
        avatar: "M"
      }
    ];

    // Dummy recommendations
    const recommendations = [
      {
        emoji: "üöÄ",
        title: "Space Adventure",
        description: "Journey through the stars with alien friends"
      },
      {
        emoji: "ü¶ï",
        title: "Dinosaur Discovery",
        description: "Travel back in time to meet friendly dinos"
      },
      {
        emoji: "üßö",
        title: "Fairy Garden",
        description: "Magical creatures in an enchanted garden"
      },
      {
        emoji: "üè¥‚Äç‚ò†Ô∏è",
        title: "Pirate Treasure",
        description: "Sail the seven seas looking for gold"
      },
      {
        emoji: "ü¶∏",
        title: "Superhero Training",
        description: "Learn superpowers at hero academy"
      },
      {
        emoji: "üêâ",
        title: "Dragon Friend",
        description: "Befriend a baby dragon learning to fly"
      }
    ];

    // Utility: Get/Set favorites
    function getFavorites() {
      try {
        return JSON.parse(localStorage.getItem('yw_favorites') || '[]');
      } catch(_) { return []; }
    }
    function setFavorites(favs) {
      try {
        localStorage.setItem('yw_favorites', JSON.stringify(favs));
      } catch(_) {}
    }
    function toggleFavorite(storyId) {
      const favs = getFavorites();
      const idx = favs.indexOf(storyId);
      if (idx > -1) {
        favs.splice(idx, 1);
      } else {
        favs.push(storyId);
      }
      setFavorites(favs);
      return favs.includes(storyId);
    }
    function isFavorite(storyId) {
      return getFavorites().includes(storyId);
    }

    // Utility: Get/Set collections
    function getCollections() {
      try {
        return JSON.parse(localStorage.getItem('yw_collections') || '{}');
      } catch(_) { return {}; }
    }
    function setCollections(collections) {
      try {
        localStorage.setItem('yw_collections', JSON.stringify(collections));
      } catch(_) {}
    }
    function addToCollection(storyId, collection) {
      const collections = getCollections();
      if (!collections[storyId]) collections[storyId] = [];
      if (!collections[storyId].includes(collection)) {
        collections[storyId].push(collection);
      }
      setCollections(collections);
    }
    function removeFromCollection(storyId, collection) {
      const collections = getCollections();
      if (collections[storyId]) {
        collections[storyId] = collections[storyId].filter(c => c !== collection);
      }
      setCollections(collections);
    }
    function getStoryCollections(storyId) {
      const collections = getCollections();
      return collections[storyId] || [];
    }

    // Utility: Recent activity tracking
    function getRecentActivity() {
      try {
        return JSON.parse(localStorage.getItem('yw_recent_activity') || '[]');
      } catch(_) { return []; }
    }
    function addRecentActivity(storyId, storyTitle) {
      try {
        let recent = getRecentActivity();
        // Remove if already exists
        recent = recent.filter(r => r.id !== storyId);
        // Add to front
        recent.unshift({
          id: storyId,
          title: storyTitle,
          timestamp: Date.now()
        });
        // Keep only last 5
        recent = recent.slice(0, 5);
        localStorage.setItem('yw_recent_activity', JSON.stringify(recent));
      } catch(_) {}
    }

    // Utility: Format time ago
    function timeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'Just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      return new Date(timestamp).toLocaleDateString();
    }

    // ========================================
    // FEATURE 1: TESTIMONIAL CAROUSEL
    // ========================================
    let currentTestimonialIndex = 0;

    function renderTestimonial(index) {
      const t = testimonials[index];
      const stars = '‚òÖ'.repeat(t.rating) + '‚òÜ'.repeat(5 - t.rating);
      
      const html = `
        <div class="testimonial-header">
          <div class="testimonial-avatar">${t.avatar}</div>
          <div class="testimonial-info">
            <div class="testimonial-name">${t.name}</div>
            <div class="testimonial-role">${t.role}</div>
          </div>
          <div class="testimonial-stars">${stars}</div>
        </div>
        <blockquote class="t-quote">"${t.quote}"</blockquote>
      `;
      
      document.getElementById('currentTestimonial').innerHTML = html;
    }

    function renderTestimonialNav() {
      const nav = document.getElementById('testimonialNav');
      nav.innerHTML = testimonials.map((_, i) => 
        `<button class="carousel-dot ${i === currentTestimonialIndex ? 'active' : ''}" data-index="${i}"></button>`
      ).join('');
      
      nav.addEventListener('click', (e) => {
        if (e.target.classList.contains('carousel-dot')) {
          currentTestimonialIndex = parseInt(e.target.dataset.index);
          renderTestimonial(currentTestimonialIndex);
          renderTestimonialNav();
        }
      });
    }

    function initTestimonials() {
      renderTestimonial(currentTestimonialIndex);
      renderTestimonialNav();
      
      // Auto-rotate every 5 seconds
      setInterval(() => {
        currentTestimonialIndex = (currentTestimonialIndex + 1) % testimonials.length;
        renderTestimonial(currentTestimonialIndex);
        renderTestimonialNav();
      }, 5000);
    }

    // ========================================
    // FEATURE 2: RECOMMENDATIONS CAROUSEL
    // ========================================
    function renderRecommendations() {
      const carousel = document.getElementById('recCarousel');
      carousel.innerHTML = recommendations.map((rec, i) => `
        <div class="rec-card" data-rec-index="${i}">
          <div class="rec-card-emoji">${rec.emoji}</div>
          <div class="rec-card-title">${rec.title}</div>
          <div class="rec-card-desc">${rec.description}</div>
        </div>
      `).join('');
      
      carousel.addEventListener('click', (e) => {
        const card = e.target.closest('.rec-card');
        if (card) {
          const index = parseInt(card.dataset.recIndex);
          const rec = recommendations[index];
          // Store suggestion in sessionStorage for create.html to use
          try {
            sessionStorage.setItem('yw_story_suggestion', JSON.stringify(rec));
          } catch(_) {}
          document.body.classList.add('fade-out');
          setTimeout(() => { window.location.href = 'create.html'; }, 120);
        }
      });
    }

    // ========================================
    // FEATURE 3: RECENT ACTIVITY
    // ========================================
    function renderRecentActivity() {
      const recent = getRecentActivity();
      const recentSection = document.getElementById('recentActivity');
      const recentList = document.getElementById('recentList');
      
      if (recent.length === 0) {
        recentSection.style.display = 'none';
        return;
      }
      
      recentSection.style.display = 'block';
      recentList.innerHTML = recent.map(r => `
        <div class="recent-item" data-story-id="${r.id}">
          <span class="recent-item-title">${r.title}</span>
          <span class="recent-item-time">${timeAgo(r.timestamp)}</span>
        </div>
      `).join('');
      
      recentList.addEventListener('click', (e) => {
        const item = e.target.closest('.recent-item');
        if (item) {
          const storyId = item.dataset.storyId;
          try { sessionStorage.setItem('yw_story_id', storyId); } catch(_) {}
          document.body.classList.add('fade-out');
          setTimeout(() => { window.location.href = 'storydetail.html'; }, 120);
        }
      });
    }

    // ========================================
    // FEATURE 4: USAGE TRACKING
    // ========================================
    // Usage tracking is now handled by loadSubscriptionStatus() which calls the API

    // ========================================
    // PERSONALIZE WELCOME
    // ========================================
    function getChildNameFromTranscript() {
      try {
        const raw = sessionStorage.getItem('yw_transcript') || '';
        const m = raw.match(/Child name:\s*([^\n]+)/i);
        const name = (m && m[1] ? m[1].trim() : '').replace(/[^A-Za-z√áƒûƒ∞√ñ≈û√ú√ßƒüƒ±√∂≈ü√º' -]/g, '');
        return name || '';
      } catch (_) { return ''; }
    }
    const kid = getChildNameFromTranscript();
    const title = document.getElementById('welcomeTitle');
    const desc  = document.getElementById('welcomeDesc');
    if (kid && title && desc) {
      title.textContent = `Welcome to your story world, ${kid} üåô`;
      desc.textContent  = `Your first magical story is ready to read with ${kid} tonight.`;
    }

    // Open free story ‚Üí detail page or create page if no stories
    const openBtn = document.getElementById('openStoryBtn');
    if (openBtn) {
      openBtn.addEventListener('click', async function() {
        // Check if user has any stories
        try {
          const token = localStorage.getItem('yw_jwt_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) headers['Authorization'] = `Bearer ${token}`;
          
          const res = await fetch('https://storyai-backend-production.up.railway.app/api/v1/stories/my', {
            credentials: 'include',
            headers: headers
          });
          
          if (res.ok) {
            const data = await res.json();
            const stories = data?.data?.stories || [];
            
            if (stories.length > 0) {
              // User has stories, open the most recent one
              const latestStory = stories.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
              sessionStorage.setItem('yw_story_id', latestStory._id);
              document.body.classList.add('fade-out');
              setTimeout(() => { window.location.href = 'storydetail.html'; }, 120);
            } else {
              // No stories yet, guide to create one
              document.body.classList.add('fade-out');
              setTimeout(() => { window.location.href = 'create.html'; }, 120);
            }
          } else {
            // Error fetching stories, default to detail page
            document.body.classList.add('fade-out');
            setTimeout(() => { window.location.href = 'storydetail.html'; }, 120);
          }
        } catch (e) {
          console.error('Error checking stories:', e);
          // Fallback to create page on error
          document.body.classList.add('fade-out');
          setTimeout(() => { window.location.href = 'create.html'; }, 120);
        }
      });
    }

    // ========================================
    // STRIPE SUBSCRIPTION INTEGRATION
    // ========================================
    const PAYMENT_API_BASE = 'https://storyai-backend-production.up.railway.app/api/v1/payments';
    
    // Plan names match API directly now: basic, plus, premium, infinite
    const PLAN_DISPLAY_NAMES = {
      'basic': 'Basic',
      'plus': 'Plus',
      'premium': 'Premium',
      'infinite': 'Infinite'
    };

    // Create Stripe checkout session and redirect
    async function startCheckout(plan, interval = 'monthly') {
      // Plan names now match API directly (plus, premium, infinite)
      
      // Show loading state
      const loadingModal = showLoadingModal('Preparing checkout...');
      
      try {
        const token = localStorage.getItem('yw_jwt_token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        
        const response = await fetch(`${PAYMENT_API_BASE}/create-checkout-session`, {
          method: 'POST',
          credentials: 'include',
          headers: headers,
          body: JSON.stringify({
            plan: plan,
            interval: interval
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || data.error || 'Failed to create checkout session');
        }
        
        if (data.status === 'success' && data.url) {
          // Store that we're expecting a subscription callback
          try {
            sessionStorage.setItem('yw_pending_subscription', JSON.stringify({
              plan: apiPlan,
              interval: interval,
              startedAt: Date.now()
            }));
          } catch(_) {}
          
          // Redirect to Stripe checkout
          loadingModal.remove();
          window.location.href = data.url;
        } else {
          throw new Error('Invalid response from server');
        }
        
      } catch (error) {
        loadingModal.remove();
        console.error('Checkout error:', error);
        alert('Failed to start checkout: ' + (error.message || 'Please try again.'));
      }
    }

    // Show loading modal helper
    function showLoadingModal(message) {
      const modal = document.createElement('div');
      modal.id = 'loadingModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(58, 52, 80, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(8px);
      `;
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 20px;
          padding: 40px;
          max-width: 400px;
          width: 90%;
          text-align: center;
          box-shadow: 0 20px 60px rgba(142, 68, 236, 0.3);
        ">
          <div class="wait-dots" aria-hidden="true" style="margin-bottom: 24px;">
            <span></span><span></span><span></span>
          </div>
          <p style="color: var(--plum-dark); margin: 0; font-size: 18px; font-weight: 600;">
            ${message}
          </p>
        </div>
      `;
      document.body.appendChild(modal);
      return modal;
    }

    // Poll subscription status after returning from Stripe
    async function pollSubscriptionStatus(maxDuration = 120000) { // 2 minutes
      const startTime = Date.now();
      const pollInterval = 2000; // Poll every 2 seconds
      
      const modal = showLoadingModal('Confirming your subscription...');
      
      const updateMessage = (msg) => {
        const msgEl = modal.querySelector('p');
        if (msgEl) msgEl.textContent = msg;
      };
      
      const poll = async () => {
        try {
          const token = localStorage.getItem('yw_jwt_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) headers['Authorization'] = `Bearer ${token}`;
          
          const res = await fetch(`${PAYMENT_API_BASE}/my-subscription`, {
            credentials: 'include',
            headers: headers
          });
          
          const data = await res.json();
          
          if (data.status === 'success' && data.data?.hasSubscription) {
            // Subscription confirmed!
            modal.remove();
            
            // Clear pending subscription flag
            try { sessionStorage.removeItem('yw_pending_subscription'); } catch(_) {}
            
            // Show success message
            showSubscriptionSuccess(data.data.subscription);
            
            // Update UI with new subscription data
            updateSubscriptionUI(data.data);
            
            return true;
          }
          
          // Check timeout
          if (Date.now() - startTime >= maxDuration) {
            modal.remove();
            alert('Subscription confirmation is taking longer than expected. Please refresh the page or contact support if the issue persists.');
            try { sessionStorage.removeItem('yw_pending_subscription'); } catch(_) {}
            return false;
          }
          
          // Continue polling
          updateMessage('Still confirming... Please wait.');
          setTimeout(poll, pollInterval);
          
        } catch (error) {
          console.error('Polling error:', error);
          
          // Check timeout
          if (Date.now() - startTime >= maxDuration) {
            modal.remove();
            alert('Failed to confirm subscription. Please refresh the page or contact support.');
            try { sessionStorage.removeItem('yw_pending_subscription'); } catch(_) {}
            return false;
          }
          
          // Retry on error
          setTimeout(poll, pollInterval);
        }
      };
      
      poll();
    }

    // Show subscription success modal
    function showSubscriptionSuccess(subscription) {
      const planName = PLAN_DISPLAY_NAMES[subscription.plan] || 
                       subscription.plan.charAt(0).toUpperCase() + subscription.plan.slice(1);
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(58, 52, 80, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(8px);
      `;
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 20px;
          padding: 40px;
          max-width: 450px;
          width: 90%;
          text-align: center;
          box-shadow: 0 20px 60px rgba(142, 68, 236, 0.3);
        ">
          <div style="font-size: 64px; margin-bottom: 16px;">üéâ</div>
          <h2 style="color: var(--plum-dark); margin: 0 0 12px; font-size: 28px;">
            Welcome to ${planName}!
          </h2>
          <p style="color: #6b6479; margin: 0 0 24px; font-size: 16px; line-height: 1.5;">
            Your subscription is now active. Enjoy unlimited stories and premium features!
          </p>
          <button class="btn" onclick="this.closest('div').parentElement.remove();" style="width: 100%;">
            Start Creating Stories
          </button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Update UI with subscription data
    function updateSubscriptionUI(subData) {
      if (!subData) return;
      
      const { subscription, limits, usage } = subData;
      
      // Update plan cards to show current plan
      document.querySelectorAll('.plan-card').forEach(card => {
        const cardPlan = card.getAttribute('data-plan');
        const btn = card.querySelector('.btn');
        
        if (cardPlan === subscription?.plan) {
          // This is the current plan
          if (btn) {
            btn.textContent = 'Current Plan';
            btn.disabled = true;
            btn.classList.add('ghost');
            btn.classList.remove('btn');
            btn.classList.add('btn');
          }
        } else if (btn && btn.hasAttribute('data-upgrade')) {
          // Reset other plan buttons
          btn.disabled = false;
          btn.classList.remove('ghost');
        }
      });
      
      // Update Basic plan card if user has subscription
      if (subscription?.status === 'active' && subscription?.plan !== 'basic') {
        const basicCard = document.querySelector('.plan-card.basic .btn');
        if (basicCard) {
          basicCard.textContent = 'Basic Plan';
          basicCard.disabled = true;
          basicCard.classList.add('ghost');
        }
      }
      
      // Refresh subscription info from API to update usage bars correctly
      loadSubscriptionStatus();
    }

    // Check for pending subscription on page load (user returning from Stripe)
    function checkPendingSubscription() {
      // Check URL parameters first (more reliable)
      const urlParams = new URLSearchParams(window.location.search);
      const subscriptionStatus = urlParams.get('subscription');
      
      // Clean URL (remove subscription parameter)
      const cleanUrl = () => {
        const newUrl = window.location.pathname;
        window.history.replaceState({}, '', newUrl);
      };
      
      if (subscriptionStatus === 'success') {
        console.log('[Subscription] User returned from Stripe with success');
        cleanUrl();
        pollSubscriptionStatus();
        return;
      }
      
      if (subscriptionStatus === 'cancel') {
        console.log('[Subscription] User cancelled Stripe checkout');
        cleanUrl();
        // Show cancellation message
        const cancelMsg = document.createElement('div');
        cancelMsg.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: #f59e0b;
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          font-weight: 600;
          z-index: 9999;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        `;
        cancelMsg.textContent = 'Checkout cancelled. You can try again anytime!';
        document.body.appendChild(cancelMsg);
        setTimeout(() => {
          cancelMsg.style.opacity = '0';
          cancelMsg.style.transition = 'opacity 0.3s';
          setTimeout(() => cancelMsg.remove(), 300);
        }, 4000);
        // Clear any pending subscription data
        try { sessionStorage.removeItem('yw_pending_subscription'); } catch(_) {}
        return;
      }
      
      // Fallback: check sessionStorage (in case URL param was lost)
      try {
        const pending = sessionStorage.getItem('yw_pending_subscription');
        if (pending) {
          const data = JSON.parse(pending);
          // Only poll if started within last 5 minutes
          if (Date.now() - data.startedAt < 300000) {
            console.log('[Subscription] Detected pending subscription from sessionStorage, starting poll...');
            pollSubscriptionStatus();
          } else {
            sessionStorage.removeItem('yw_pending_subscription');
          }
        }
      } catch(_) {}
    }

    // Load current subscription status on page load
    async function loadSubscriptionStatus() {
      try {
        const token = localStorage.getItem('yw_jwt_token');
        if (!token) return;
        
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
        const API_BASE = 'https://storyai-backend-production.up.railway.app/api/v1';
        
        const res = await fetch(`${API_BASE}/users/subscription-info`, {
          credentials: 'include',
          headers: headers
        });
        
        const data = await res.json();
        console.log('[Subscription] Loaded subscription info:', data);
        
        if (data.status === 'success' && data.data) {
          updateSubscriptionUIFromInfo(data.data);
        }
      } catch (error) {
        console.error('Failed to load subscription status:', error);
      }
    }
    
    // Update UI with subscription-info response
    function updateSubscriptionUIFromInfo(info) {
      if (!info) return;
      
      const { subscriptionPlan, planLimits, usage, remaining, walletBalance } = info;
      
      console.log('[Subscription] Updating UI with:', { subscriptionPlan, planLimits, usage, remaining });
      
      // Update plan cards to show current plan
      document.querySelectorAll('.plan-card').forEach(card => {
        const cardPlan = card.getAttribute('data-plan');
        const btn = card.querySelector('.btn');
        
        if (cardPlan === subscriptionPlan) {
          // This is the current plan
          if (btn) {
            btn.textContent = 'Current Plan';
            btn.disabled = true;
            btn.classList.add('ghost');
          }
          // Add visual indicator
          card.style.border = '2px solid var(--plum)';
        } else if (btn && btn.hasAttribute('data-upgrade')) {
          // Reset other plan buttons
          btn.disabled = false;
          btn.classList.remove('ghost');
        }
      });
      
      // Update usage bars - show remaining / total format
      if (planLimits && remaining) {
        const storiesBar = document.getElementById('freeStoriesBar');
        const storiesText = document.getElementById('freeStoriesText');
        const imageStoriesBar = document.getElementById('imageStoriesBar');
        const imageStoriesText = document.getElementById('imageStoriesText');
        const voicesBar = document.getElementById('freeVoicesBar');
        const voicesText = document.getElementById('freeVoicesText');
        
        console.log('[Subscription] Updating bars:', { storiesBar, imageStoriesBar, voicesBar });
        
        // Text stories - show remaining/total
        if (storiesBar && storiesText && planLimits.textStories) {
          const total = planLimits.textStories;
          const left = remaining.textStories ?? total;
          const percentRemaining = (left / total) * 100;
          console.log('[Subscription] Text stories:', { left, total, percentRemaining });
          storiesBar.style.width = percentRemaining + '%';
          storiesText.textContent = `${left}/${total} text stories`;
          
          // Change color if running low
          if (percentRemaining <= 10) {
            storiesBar.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
          } else if (percentRemaining <= 30) {
            storiesBar.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
          } else {
            storiesBar.style.background = 'linear-gradient(90deg, #8E44EC, #B67AF3)';
          }
        }
        
        // Image stories - show remaining/total
        if (imageStoriesBar && imageStoriesText && planLimits.imageStories !== undefined) {
          const total = planLimits.imageStories;
          if (total === 0) {
            imageStoriesBar.style.width = '0%';
            imageStoriesText.textContent = 'Upgrade for image stories';
          } else {
            const left = remaining.imageStories ?? total;
            const percentRemaining = (left / total) * 100;
            imageStoriesBar.style.width = percentRemaining + '%';
            imageStoriesText.textContent = `${left}/${total} image stories`;
            
            // Change color if running low
            if (percentRemaining <= 10) {
              imageStoriesBar.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
            } else if (percentRemaining <= 30) {
              imageStoriesBar.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
            } else {
              imageStoriesBar.style.background = 'linear-gradient(90deg, #8E44EC, #B67AF3)';
            }
          }
        }
        
        // Voice clones - show remaining/total
        if (voicesBar && voicesText && planLimits.voiceClones !== undefined) {
          const total = planLimits.voiceClones;
          if (total === 0) {
            voicesBar.style.width = '0%';
            voicesText.textContent = 'Upgrade for voice cloning';
          } else {
            const left = remaining.voiceClones ?? total;
            const percentRemaining = (left / total) * 100;
            voicesBar.style.width = percentRemaining + '%';
            voicesText.textContent = `${left}/${total} voice clones`;
            
            // Change color if running low
            if (percentRemaining <= 10) {
              voicesBar.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
            } else if (percentRemaining <= 30) {
              voicesBar.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
            } else {
              voicesBar.style.background = 'linear-gradient(90deg, #8E44EC, #B67AF3)';
            }
          }
        }
      }
      
      // Show wallet balance if available
      if (walletBalance !== undefined) {
        const walletEl = document.getElementById('walletBalance');
        if (walletEl) {
          walletEl.textContent = `${walletBalance} coins`;
        }
      }
    }

    // Upgrade button handler
    function goUpgrade(tier) {
      // Check if user is logged in
      const token = localStorage.getItem('yw_jwt_token');
      if (!token) {
        alert('Please sign in to upgrade your plan.');
        // Optionally open auth modal here
        return;
      }
      
      startCheckout(tier, 'monthly');
    }
    
    document.querySelectorAll('[data-upgrade]').forEach(btn => {
      btn.addEventListener('click', () => goUpgrade(btn.getAttribute('data-upgrade')));
    });

    // StoryBud CTAs (placeholder)
    const buy = document.getElementById('buyStoryBudBtn');
    const learn = document.getElementById('learnStoryBudBtn');
    if (buy)   buy.addEventListener('click', () => alert('StoryBud purchase flow coming soon. Includes 3 months of Premium.'));
    if (learn) learn.addEventListener('click', () => alert('StoryBud details page coming soon.'));

    // Mobile sticky CTA ‚Üí upgrade
    const mobileCta = document.getElementById('mobileCta');
    if (mobileCta) {
      mobileCta.addEventListener('click', (e) => {
        e.preventDefault();
        goUpgrade('pro');
      });
    }

    // ===== LOAD MY STORIES WITH NEW FEATURES =====
    const API_BASE = 'https://storyai-backend-production.up.railway.app/api/v1';
    async function loadMyStories() {
      const listEl = document.getElementById('storiesList');
      if (!listEl) return;

      // Helper: paint empty states
      const paintEmpty = (msg) => {
        listEl.innerHTML = '';
        let empty = listEl.previousElementSibling;
        // Remove previous empties if re-rendered
        if (empty && empty.classList && empty.classList.contains('stories-empty')) {
          empty.remove();
        }
        empty = document.createElement('div');
        empty.className = 'stories-empty';
        empty.innerHTML = msg;
        listEl.parentElement.insertBefore(empty, listEl);
        listEl.style.display = 'none';
      };

      try {
        // Get JWT token from localStorage for authentication
        const token = localStorage.getItem('yw_jwt_token');
        console.log('[loadMyStories] Token exists:', !!token);
        
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        // Ask for user stories with JWT auth
        const res = await fetch(`${API_BASE}/stories/my`, { 
          credentials: 'include',
          headers: headers
        });
        
        if (!res.ok) {
          throw new Error('UNAUTH');
        }
        
        const data = await res.json();
        const stories = data?.data?.stories || [];

        // Check if there's a cached story in sessionStorage that's not in the database
        let cachedStory = null;
        try {
          const cachedStoryJson = sessionStorage.getItem('yw_current_story');
          if (cachedStoryJson) {
            cachedStory = JSON.parse(cachedStoryJson);
            console.log('[loadMyStories] Found cached story in sessionStorage:', cachedStory.title);
          }
        } catch(e) {
          console.error('[loadMyStories] Error parsing cached story:', e);
        }

        // If no stories in database but we have a cached one, add it to the list
        if (!stories.length && cachedStory) {
          console.log('[loadMyStories] No stories in DB, but found cached story. Adding to display.');
          stories.push({
            _id: 'cached-story',
            title: cachedStory.title || 'Your Story',
            createdAt: new Date().toISOString(),
            pages: cachedStory.pages || [],
            isCached: true
          });
        }

        if (!stories.length) {
          paintEmpty(`<b>No stories yet.</b> Create your first one below!`);
          return;
        }

        // Clear previous empty and show list
        const prevEmpty = listEl.previousElementSibling;
        if (prevEmpty && prevEmpty.classList.contains('stories-empty')) prevEmpty.remove();
        listEl.style.display = '';

        // FILTER BY COLLECTION
        const currentFilter = document.getElementById('collectionFilter').value;
        
        let filteredStories = stories;
        if (currentFilter === 'favorites') {
          const favs = getFavorites();
          filteredStories = stories.filter(s => favs.includes(s._id));
        } else if (currentFilter !== 'all') {
          filteredStories = stories.filter(s => {
            const collections = getStoryCollections(s._id);
            return collections.includes(currentFilter);
          });
        }

        if (filteredStories.length === 0) {
          paintEmpty(`<b>No stories in this collection.</b> Try another filter or create a new story!`);
          return;
        }

        listEl.innerHTML = filteredStories
          .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt))
          .map(s => {
            const cover = (s.pages && s.pages[0] && s.pages[0].imageUrl) || s.coverUrl || 'childsdreambanner.png';
            const created = s.createdAt ? new Date(s.createdAt).toLocaleDateString() : '';
            const cachedBadge = s.isCached ? '<span class="story-badge">Cached</span>' : '';
            const collections = getStoryCollections(s._id);
            const collectionBadge = collections.length > 0 ? `<span class="story-badge">${collections[0]}</span>` : '';
            const favorite = isFavorite(s._id);
            
            return `
              <li class="story-item" data-story-id="${s._id}">
                <div class="story-cover"><img src="${cover}" alt="${(s.title || 'Story cover').replace(/"/g,'&quot;')}" /></div>
                <div class="story-info">
                  <h3>${s.title || 'Untitled Story'}${cachedBadge}${collectionBadge}</h3>
                  <p class="story-meta">${created ? 'Created ' + created : ''}${s.isCached ? ' ‚Ä¢ Not yet saved to account' : ''}</p>
                  <button class="btn ghost small" data-open-story="${s._id}">Open</button>
                </div>
                <button class="favorite-btn ${favorite ? 'active' : ''}" data-fav-story="${s._id}" title="${favorite ? 'Remove from favorites' : 'Add to favorites'}">
                  ${favorite ? '‚ù§Ô∏è' : 'ü§ç'}
                </button>
              </li>`;
          }).join('');

        // Delegate open clicks
        listEl.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-open-story]');
          if (btn) {
            const id = btn.getAttribute('data-open-story');
            if (!id) return;
            
            // Track recent activity
            const storyItem = btn.closest('.story-item');
            const storyTitle = storyItem.querySelector('h3').textContent.trim();
            addRecentActivity(id, storyTitle);
            
            // If it's a cached story, we already have it in sessionStorage
            if (id === 'cached-story') {
              console.log('[loadMyStories] Opening cached story from sessionStorage');
            } else {
              // For database stories, store the ID so storydetail can fetch it
              try { sessionStorage.setItem('yw_story_id', id); } catch(_) {}
            }
            
            document.body.classList.add('fade-out');
            setTimeout(()=>{ window.location.href = 'storydetail.html'; }, 120);
            return;
          }

          // Handle favorite toggle
          const favBtn = e.target.closest('[data-fav-story]');
          if (favBtn) {
            e.stopPropagation();
            const id = favBtn.getAttribute('data-fav-story');
            const nowFav = toggleFavorite(id);
            favBtn.textContent = nowFav ? '‚ù§Ô∏è' : 'ü§ç';
            favBtn.classList.toggle('active', nowFav);
            favBtn.title = nowFav ? 'Remove from favorites' : 'Add to favorites';
          }
        });

      } catch (_) {
        // Not signed in or server unavailable ‚Üí graceful message
        paintEmpty('Sign in to see your saved stories.');
      }
    }

    // Collection filter change
    document.getElementById('collectionFilter')?.addEventListener('change', () => {
      loadMyStories();
    });

    // Manage collections modal (dummy implementation)
    document.getElementById('manageCollectionsBtn')?.addEventListener('click', () => {
      const storyId = prompt('Enter story ID to manage collections (this is a demo):');
      if (!storyId) return;
      
      const collections = getStoryCollections(storyId);
      const action = prompt(`Current collections: ${collections.join(', ') || 'none'}.\n\nType 'add:bedtime' or 'remove:adventure' to manage:`);
      if (!action) return;
      
      const [cmd, collection] = action.split(':');
      if (cmd === 'add') {
        addToCollection(storyId, collection);
        alert(`Added to ${collection}!`);
        loadMyStories();
      } else if (cmd === 'remove') {
        removeFromCollection(storyId, collection);
        alert(`Removed from ${collection}!`);
        loadMyStories();
      }
    });

    // Create new story ‚Üí your chat experience page (create.html)
    document.getElementById('createNewStoryBtn')?.addEventListener('click', () => {
      document.body.classList.add('fade-out');
      setTimeout(()=>{ window.location.href = 'create.html'; }, 120);
    });

    // ========================================
    // INIT ALL FEATURES
    // ========================================
    initTestimonials();
    renderRecommendations();
    renderRecentActivity();
    loadMyStories();
    
    // Subscription checks
    checkPendingSubscription(); // Check if returning from Stripe
    loadSubscriptionStatus();   // Load current subscription status

    // Set year in footer
    document.getElementById('year').textContent = new Date().getFullYear();
  })();
  </script>

</body>
</html>
