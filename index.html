<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Fairytale Generator ‚Äî Calm Reading Mode for Parents</title>
  <meta name="description" content="Generate gentle, interactive bedtime stories from your parent‚Äìchild chat." />
  <style>
    /* --------- Design Tokens --------- */
    :root{
      --bg: #faf7f2;
      --card: #ffffff;
      --ink: #1f1f1f;
      --muted: #5f5f5f;
      --brand: #7b5cff;
      --brand-2: #ffb86b;
      --accent: #6dd3a4;
      --danger: #ff6b6b;
      --border: #e9e2d9;
      --shadow: 0 6px 20px rgba(31,31,31,.08);
      --radius: 16px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1115; --card:#16181e; --ink:#f6f6f6; --muted:#b9c0cf;
        --border:#272b33; --shadow: 0 6px 20px rgba(0,0,0,.35)
      }
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    a{color:inherit}
    .wrap{max-width:960px;margin-inline:auto;padding:16px;display:grid;gap:16px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2));box-shadow:var(--shadow);display:grid;place-items:center}
    .logo svg{filter:drop-shadow(0 2px 4px rgba(0,0,0,.15))}
    .title h1{font-size:18px;margin:0 0 2px;font-weight:700;letter-spacing:.2px}
    .title p{margin:0;color:var(--muted);font-size:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .grid{display:grid;gap:16px}
    @media(min-width:960px){ .grid{grid-template-columns:360px 1fr} }

    /* --------- Controls --------- */
    .panel{padding:16px;display:grid;gap:14px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    textarea,input{width:100%;border:1px solid var(--border);background:transparent;color:var(--ink);border-radius:12px;padding:12px 14px;font-size:15px;outline:none}
    textarea{min-height:110px;resize:vertical;line-height:1.4}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid var(--border);background:var(--card);color:var(--ink);
      padding:12px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:.2s transform, .2s background, .2s border;
      display:inline-flex;gap:8px;align-items:center
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.primary{background:var(--brand);border-color:transparent;color:white}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--danger);border-color:transparent;color:white}
    .hint{font-size:12px;color:var(--muted)}

    /* --------- Listening Indicator --------- */
    .listening{
      display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px dashed var(--border);border-radius:12px
    }
    .dotbar{display:flex;gap:4px;align-items:flex-end;height:16px}
    .dotbar span{width:6px;border-radius:3px;background:var(--brand);display:block;animation:bars 900ms ease-in-out infinite}
    .dotbar span:nth-child(2){animation-delay:.1s}
    .dotbar span:nth-child(3){animation-delay:.2s}
    .dotbar span:nth-child(4){animation-delay:.3s}
    @keyframes bars{
      0%,100%{height:4px;opacity:.7}
      50%{height:16px;opacity:1}
    }
    .live-pill{font-size:11px;background:var(--accent);color:#083b2d;padding:2px 8px;border-radius:999px;font-weight:700}

    /* --------- Story Area --------- */
    .story{padding:20px 18px 24px;display:grid;gap:12px}
    .page{
      background:linear-gradient(180deg, rgba(123,92,255,0.05), transparent 160px);
      border:1px solid var(--border);border-radius:16px;padding:18px;line-height:1.8;font-size:19px;
      min-height:220px; position:relative; overflow:hidden
    }
    .page p{margin:0 0 12px}
    .page .fade{opacity:.75}
    .skeleton{
      --h:16px;display:grid;gap:8px
    }
    .skeleton div{height:var(--h);background:linear-gradient(90deg,rgba(0,0,0,.06),rgba(0,0,0,.12),rgba(0,0,0,.06));
      background-size:200% 100%;animation:sheen 1.2s linear infinite;border-radius:8px}
    @keyframes sheen{0%{background-position:200% 0}100%{background-position:0 0}}
    .meta{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
    .meta .pill{background:rgba(123,92,255,.12);color:var(--brand);padding:2px 8px;border-radius:999px;font-weight:700}

    /* --------- Footer --------- */
    footer{padding:10px 2px 28px;color:var(--muted);text-align:center;font-size:12px}

    /* --------- Accessibility helpers --------- */
    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- book + sparkle -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff" aria-hidden="true">
            <path d="M3 6a3 3 0 0 1 3-3h11a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a3 3 0 0 1-3-3V6zM6 5a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h12V5H6z"/>
            <path d="M17.5 2.5l.7 1.4 1.6.2-1.2 1 .3 1.6-1.4-.8-1.4.8.3-1.6-1.2-1 1.6-.2.7-1.4z"/>
          </svg>
        </div>
        <div class="title">
          <h1>Fairytale Generator</h1>
          <p>Gentle, interactive stories from your chat with your child (ages 3‚Äì5)</p>
        </div>
      </div>
      <div class="row">
        <button id="toggleTheme" class="btn ghost" aria-label="Toggle theme">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          Theme
        </button>
        <!-- API status pill -->
        <span id="apiStatus" class="btn ghost" style="pointer-events:none">‚è≥ Checking API‚Ä¶</span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Parent Controls -->
      <section class="card panel" aria-label="Parent controls">
        <div>
          <div class="label">Parent‚Äìchild chat (brief notes)</div>
          <textarea id="conversation" placeholder="Ex: Dinozor, adƒ± Trex olsun; ormanda kaybolsun; bulut balonu; arkada≈üƒ± Triceratops yardƒ±m etsin‚Ä¶"></textarea>
          <div class="hint">Tip: Yazarken √ßocuƒüun s√∂ylediƒüi c√ºmleleri kƒ±sa kƒ±sa ekleyin. (You can write in Turkish or English.)</div>
        </div>

        <div>
          <div class="label">Tone & style</div>
          <div class="row" role="group" aria-label="Tone options">
            <button class="btn" data-tone="gentle">üåô Gentle</button>
            <button class="btn" data-tone="adventurous">üó∫Ô∏è Adventurous</button>
            <button class="btn" data-tone="silly">ü§™ Silly</button>
            <button class="btn" data-tone="custom">‚úçÔ∏è Custom</button>
          </div>
          <input id="customTone" placeholder="Optional custom tone (e.g., ‚Äòsoothing bedtime, 5-minute story‚Äô)" />
        </div>

        <div class="listening" id="listeningBox" aria-live="polite">
          <span class="live-pill" id="listenState">Idle</span>
          <div class="dotbar" aria-hidden="true"><span></span><span></span><span></span><span></span></div>
          <div style="flex:1"></div>
          <button id="micBtn" class="btn" aria-pressed="false" aria-label="Start/stop listening">
            üé§ Start Listening
          </button>
        </div>

        <div class="row">
          <button id="generateBtn" class="btn primary">‚ú® Generate Story</button>
          <button id="continueBtn" class="btn">‚û°Ô∏è Next Page</button>
          <button id="regenerateBtn" class="btn">üîÑ Regenerate Page</button>
          <button id="resetBtn" class="btn ghost">üßπ Reset</button>
        </div>
        <div class="hint">The app never auto-advances pages. You stay in control. When your child adds ideas, press <b>Regenerate Page</b>.</div>
      </section>

      <!-- Right: Story Area -->
      <section class="card story" aria-label="Story">
        <div class="meta">
          <div>Reading mode ‚Ä¢ <span id="readingLang">EN</span></div>
          <div class="pill" id="pagePill">Page 0</div>
        </div>
        <div class="page" id="page">
          <div class="skeleton" id="skeleton" hidden>
            <div style="width:88%"></div>
            <div style="width:92%"></div>
            <div style="width:86%"></div>
            <div style="width:60%"></div>
          </div>
          <div id="storyText" aria-live="polite">
            <p class="fade">Your story will appear here with a calm, large type for bedtime reading.</p>
          </div>
        </div>
        <div class="row" style="justify-content:space-between">
          <div class="hint">Tip: Read slowly; pause at character names. Ask ‚ÄúWhat should happen next?‚Äù</div>
          <div class="row">
            <button id="bumpFont" class="btn ghost" title="Increase font">A+</button>
            <button id="dropFont" class="btn ghost" title="Decrease font">A‚àí</button>
            <button id="toggleLang" class="btn ghost" title="Switch EN/TR">üåê EN/TR</button>
          </div>
        </div>
      </section>
    </div>

    <footer>
      Crafted for calm moments. No ads. Your notes stay on this device.
    </footer>
  </div>

  <script>
    // ===== SINGLE ENDPOINT (no helpers to avoid duplication) =====
    const STORY_ENDPOINT = 'https://fairytale-api.vercel.app/api/generate-story';
    console.log('STORY_ENDPOINT =', STORY_ENDPOINT); // sanity

    // ------------------ State ------------------
    const state = {
      tone: 'gentle',
      lang: 'EN',
      pageIndex: 0,
      pages: [],
      isListening: false,
      fontSize: 19,
      recognition: null,
      abortCtrl: null,
    };

    // ------------------ Elements ------------------
    const conversationEl = document.getElementById('conversation');
    const customToneEl = document.getElementById('customTone');
    const pageEl = document.getElementById('page');
    const storyTextEl = document.getElementById('storyText');
    const skeletonEl = document.getElementById('skeleton');
    const pagePillEl = document.getElementById('pagePill');
    const listenStateEl = document.getElementById('listenState');
    const micBtn = document.getElementById('micBtn');
    const generateBtn = document.getElementById('generateBtn');
    const continueBtn = document.getElementById('continueBtn');
    const regenerateBtn = document.getElementById('regenerateBtn');
    const resetBtn = document.getElementById('resetBtn');
    const bumpFont = document.getElementById('bumpFont');
    const dropFont = document.getElementById('dropFont');
    const toggleLang = document.getElementById('toggleLang');
    const readingLang = document.getElementById('readingLang');
    const toggleTheme = document.getElementById('toggleTheme');
    const apiStatusEl = document.getElementById('apiStatus');

    // ------------------ Tone buttons ------------------
    document.querySelectorAll('[data-tone]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        state.tone = btn.dataset.tone;
        document.querySelectorAll('[data-tone]').forEach(b=>b.classList.remove('primary'));
        btn.classList.add('primary');
      });
    });

    // ------------------ Microphone (simple, optional) ------------------
    function setupSpeech(){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SpeechRecognition){
        micBtn.disabled = true;
        micBtn.textContent = 'üé§ Not available';
        return;
      }
      const rec = new SpeechRecognition();
      rec.lang = state.lang === 'EN' ? 'en-US' : 'tr-TR';
      rec.interimResults = true;
      rec.continuous = true;
      rec.onresult = (e)=>{
        let interim = '';
        for(let i=e.resultIndex;i<e.results.length;i++){
          const transcript = e.results[i][0].transcript;
          if(e.results[i].isFinal){
            conversationEl.value += (conversationEl.value ? ' ' : '') + transcript.trim();
          }else{
            interim += transcript;
          }
        }
        listenStateEl.textContent = interim ? 'Listening‚Ä¶' : 'Listening';
      };
      rec.onend = ()=> {
        if(state.isListening){ rec.start(); } // keep alive
      };
      state.recognition = rec;
    }
    setupSpeech();

    micBtn.addEventListener('click',()=>{
      if(!state.recognition) return;
      state.isListening = !state.isListening;
      micBtn.setAttribute('aria-pressed', String(state.isListening));
      if(state.isListening){
        state.recognition.lang = state.lang === 'EN' ? 'en-US' : 'tr-TR';
        state.recognition.start();
        listenStateEl.textContent = 'Listening';
        micBtn.textContent = '‚èπÔ∏è Stop Listening';
      }else{
        state.recognition.stop();
        listenStateEl.textContent = 'Idle';
        micBtn.textContent = 'üé§ Start Listening';
      }
    });

    // ------------------ Utilities ------------------
    function showSkeleton(show=true){
      skeletonEl.hidden = !show;
      storyTextEl.style.opacity = show ? .4 : 1;
    }
    function setPagePill(){
      pagePillEl.textContent = `Page ${state.pageIndex}`;
    }
    function typewriter(node, text, speed=12){
      node.innerHTML = '';
      let i = 0;
      const id = setInterval(()=>{
        node.innerHTML += text[i++] || '';
        if(i >= text.length) clearInterval(id);
      }, speed);
    }
    function compilePrompt(){
      const notes = conversationEl.value.trim();
      const baseTone = state.tone === 'custom' && customToneEl.value.trim() ? customToneEl.value.trim() : state.tone;
      const lang = state.lang === 'EN' ? 'English' : 'Turkish';
      const guidance = "Audience: 3‚Äì5 years old. Keep sentences short. Calm pacing. Avoid scary tension. 120‚Äì160 words per page. End each page with a soft micro-cliffhanger.";
      return `${guidance}\nLanguage: ${lang}\nTone: ${baseTone}\nParent‚Äìchild notes:\n${notes}\nCurrent pages so far (for continuity):\n${state.pages.map((p,i)=>`[Page ${i+1}] ${p}`).join('\n')}`;
    }
    function updateStoryUI(text){
      const safe = text.replace(/\n{3,}/g, '\n\n').trim();
      typewriter(storyTextEl, safe);
      storyTextEl.setAttribute('data-raw', safe);
      setPagePill();
    }

    // ---------- Helpers for API status + timeout ----------
    function setApiStatus(text, ok=null){
      if(!apiStatusEl) return;
      apiStatusEl.textContent = text;
      apiStatusEl.style.borderColor = ok === null ? 'var(--border)' : (ok ? 'var(--accent)' : 'var(--danger)');
    }

    async function fetchWithTimeout(url, options={}, ms=20000){
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), ms);
      try{
        return await fetch(url, { ...options, signal: ctrl.signal, mode: 'cors', credentials: 'omit', cache: 'no-store' });
      } finally {
        clearTimeout(id);
      }
    }

    async function checkApi(){
      try{
        const res = await fetchWithTimeout(STORY_ENDPOINT, { method: 'OPTIONS' }, 6000);
        if (res.ok || res.status === 204) setApiStatus('‚úÖ API ready', true);
        else setApiStatus(`‚ö†Ô∏è API ${res.status}`, false);
      } catch(e){
        setApiStatus('‚ùå API unreachable', false);
      }
    }
    checkApi();

    // ------------------ API calls ------------------
    async function callAPI(action){
      try{
        state.abortCtrl?.abort();
        state.abortCtrl = new AbortController();

        showSkeleton(true);
        const res = await fetchWithTimeout(STORY_ENDPOINT, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            action,                       // 'start' | 'next' | 'regenerate'
            prompt: compilePrompt(),
            lang: state.lang,
            pageIndex: state.pageIndex
          })
        }, 20000);

        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          throw new Error(`API ${res.status}${txt ? `: ${txt.slice(0,180)}` : ''}`);
        }
        const data = await res.json().catch(()=> ({}));
        const pageText = (data.pageText || '').trim();
        if(!pageText) throw new Error('Empty story page returned');

        if(action === 'regenerate'){
          state.pages[state.pageIndex-1] = pageText;
        }else{
          state.pages.push(pageText);
          state.pageIndex = state.pages.length;
        }
        updateStoryUI(pageText);
        setApiStatus('‚úÖ API ready', true);
      }catch(err){
        const msg = String(err && err.message || err);
        const human =
          msg.includes('AbortError') ? 'The request timed out. Internet hiccup or server slow.' :
          msg.includes('Failed to fetch') ? 'The browser could not reach the server (CORS, ad-blocker, or network).' :
          msg.startsWith('API 4') ? 'The server rejected the request. Check parameters or auth.' :
          msg.startsWith('API 5') ? 'The server had an error.' :
          'Something went wrong.';
        storyTextEl.innerHTML = `<p>Hmm, the story elves are sleepy. ${human}</p>
          <p class="fade" style="word-break:break-word">Details: ${msg}</p>`;
        setApiStatus('‚ùå API error', false);
        console.error(err);
      }finally{
        showSkeleton(false);
      }
    }

    // ------------------ Buttons ------------------
    generateBtn.addEventListener('click',()=>{
      state.pages = [];
      state.pageIndex = 0;
      callAPI('start');
    });

    continueBtn.addEventListener('click',()=>{
      if(state.pages.length === 0){
        return callAPI('start');
      }
      callAPI('next');
    });

    regenerateBtn.addEventListener('click',()=>{
      if(state.pages.length === 0){
        return callAPI('start');
      }
      callAPI('regenerate');
    });

    resetBtn.addEventListener('click',()=>{
      if(confirm('Clear notes and story?')){
        state.pages = [];
        state.pageIndex = 0;
        conversationEl.value = '';
        storyTextEl.innerHTML = '<p class="fade">Your story will appear here with a calm, large type for bedtime reading.</p>';
        setPagePill();
      }
    });

    // ------------------ Reading controls ------------------
    bumpFont.addEventListener('click',()=>{
      state.fontSize = Math.min(26, state.fontSize + 1);
      pageEl.style.fontSize = state.fontSize + 'px';
    });
    dropFont.addEventListener('click',()=>{
      state.fontSize = Math.max(16, state.fontSize - 1);
      pageEl.style.fontSize = state.fontSize + 'px';
    });
    toggleLang.addEventListener('click',()=>{
      state.lang = state.lang === 'EN' ? 'TR' : 'EN';
      readingLang.textContent = state.lang;
      if(state.recognition && state.isListening){
        state.recognition.stop();
        state.recognition.lang = state.lang === 'EN' ? 'en-US' : 'tr-TR';
        state.recognition.start();
      }
    });

    // ------------------ Theme toggle ------------------
    toggleTheme.addEventListener('click',()=>{
      if(document.documentElement.dataset.theme === 'light'){
        delete document.documentElement.dataset.theme;
      }else{
        document.documentElement.dataset.theme = 'light';
      }
    });

    // ------------------ UX niceties ------------------
    const KEY = 'ft-notes-v1';
    conversationEl.value = localStorage.getItem(KEY) || '';
    conversationEl.addEventListener('input', ()=>{
      localStorage.setItem(KEY, conversationEl.value);
    });

    // Keyboard: Cmd/Ctrl+Enter to generate/continue
    document.addEventListener('keydown', (e)=>{
      if((e.metaKey || e.ctrlKey) && e.key === 'Enter'){
        if(state.pages.length === 0) generateBtn.click();
        else continueBtn.click();
      }
    });

    // Initialize UI
    setPagePill();
  </script>
</body>
</html>
