<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Talk ‚Üí Text (Live Transcription)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f7f7fb; color: #111; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 24px; }
    header { margin-bottom: 18px; }
    h1 { font-size: 1.5rem; margin: 0 0 6px; }
    .note { font-size: 0.95rem; color: #555; }
    .card { background: #fff; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); padding: 16px; margin: 16px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button {
      border: 0; padding: 12px 16px; border-radius: 10px; font-size: 1rem; cursor: pointer;
      background: #111; color: #fff;
    }
    button.secondary { background: #e6e6ea; color: #111; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .status { display: inline-flex; align-items: center; gap: 8px; font-size: 0.95rem; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #bbb; display: inline-block; }
    .dot.live { background: #e11; box-shadow: 0 0 0 6px rgba(238,17,17,0.12); animation: pulse 1.2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
    #interim { color: #666; font-style: italic; }
    textarea {
      width: 100%; min-height: 220px; border: 1px solid #ddd; border-radius: 10px; padding: 12px;
      font: 14px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #fafafa;
    }
    .subtle { color: #666; font-size: 0.9rem; }
    label { font-size: 0.95rem; color: #333; }
    select { padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: #fff; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Talk ‚Üí Text</h1>
      <p class="note">Click <strong>Start listening</strong>, speak naturally, then click <strong>Stop listening</strong> to see the full transcription.</p>
    </header>

    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <div class="row">
          <button id="startBtn">üéôÔ∏è Start listening</button>
          <button id="stopBtn" class="secondary hidden">‚èπÔ∏è Stop listening</button>
        </div>
        <div class="row">
          <label for="language">Language:</label>
          <select id="language" title="Recognition language">
            <option value="en-GB" selected>English (UK)</option>
            <option value="en-US">English (US)</option>
            <option value="tr-TR">T√ºrk√ße</option>
            <option value="es-ES">Espa√±ol (Espa√±a)</option>
            <option value="de-DE">Deutsch</option>
            <option value="fr-FR">Fran√ßais</option>
            <option value="it-IT">Italiano</option>
          </select>
        </div>
      </div>
      <div style="margin-top: 10px;" class="status">
        <span id="statusDot" class="dot"></span>
        <span id="statusText">Idle</span>
      </div>
      <div id="unsupported" class="card hidden" style="background:#fff6f6; border:1px solid #ffd9d9;">
        <strong>Speech recognition not supported in this browser.</strong>
        <div class="subtle">Try Google Chrome or Microsoft Edge on desktop. On iPhone/iPad, Safari support is limited.</div>
      </div>
    </div>

    <div class="card">
      <strong>Live transcript (while listening):</strong>
      <p id="live"><span id="final"></span><span id="interim"></span></p>
    </div>

    <div class="card">
      <strong>Conversation transcription (after you stop):</strong>
      <textarea id="output" placeholder="Your transcription will appear here after you click Stop listening‚Ä¶" readonly></textarea>
      <div class="row" style="margin-top:10px;">
        <button id="copyBtn" class="secondary">Copy to clipboard</button>
        <button id="downloadBtn" class="secondary">Download .txt</button>
        <span id="copied" class="subtle hidden">Copied ‚úÖ</span>
      </div>
    </div>

    <p class="subtle">Tip: keep this tab in the foreground for best results. Recognition restarts automatically if it pauses on silence.</p>
  </div>

  <script>
    // 1) Feature detection
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const langSelect = document.getElementById('language');
    const finalEl = document.getElementById('final');
    const interimEl = document.getElementById('interim');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const copied = document.getElementById('copied');
    const unsupported = document.getElementById('unsupported');

    let recognition = null;
    let listening = false;
    let finalTranscript = '';

    function setStatus(isLive, text) {
      statusDot.classList.toggle('live', !!isLive);
      statusText.textContent = text;
    }
    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    if (!SR) {
      // Browser not supported
      setStatus(false, 'Not supported');
      hide(startBtn);
      hide(stopBtn);
      show(unsupported);
    } else {
      recognition = new SR();
      recognition.continuous = true;       // keep going until we stop it
      recognition.interimResults = true;   // partial results while speaking
      recognition.lang = langSelect.value; // default language

      langSelect.addEventListener('change', () => {
        recognition.lang = langSelect.value;
        // If currently listening, restart with the new language
        if (listening) {
          recognition.stop();
          setTimeout(() => recognition.start(), 150);
        }
      });

      recognition.onstart = () => {
        setStatus(true, 'Listening‚Ä¶');
      };

      recognition.onresult = (event) => {
        let interimText = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          const text = res[0].transcript;
          if (res.isFinal) {
            finalTranscript += text + ' ';
          } else {
            interimText += text;
          }
        }
        finalEl.textContent = finalTranscript;
        interimEl.textContent = interimText;
      };

      // Chrome sometimes ends on long pauses; restart automatically if still "listening"
      recognition.onend = () => {
        setStatus(false, listening ? 'Restarting‚Ä¶' : 'Idle');
        if (listening) {
          try { recognition.start(); } catch (e) { /* ignore rapid restarts */ }
        }
      };

      recognition.onerror = (event) => {
        console.warn('Speech recognition error:', event.error);
        if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
          setStatus(false, 'Microphone permission blocked');
        } else if (event.error === 'no-speech') {
          setStatus(false, 'No speech detected');
        } else {
          setStatus(false, 'Error: ' + event.error);
        }
      };

      startBtn.addEventListener('click', async () => {
        // Reset state for a new session
        finalTranscript = '';
        finalEl.textContent = '';
        interimEl.textContent = '';
        output.value = '';

        listening = true;
        startBtn.disabled = true;
        show(stopBtn);

        try {
          recognition.start(); // triggers browser mic permission prompt if needed
        } catch (e) {
          // Starting twice throws; ignore
        }
      });

      stopBtn.addEventListener('click', () => {
        listening = false;
        startBtn.disabled = false;
        hide(stopBtn);
        setStatus(false, 'Stopping‚Ä¶');
        try { recognition.stop(); } catch (e) {}

        // Show final transcript in the big box
        setTimeout(() => {
          output.value = (finalTranscript || '').trim();
          setStatus(false, 'Idle');
        }, 120);
      });
    }

    // Utilities: Copy and Download
    copyBtn.addEventListener('click', async () => {
      if (!output.value) return;
      try {
        await navigator.clipboard.writeText(output.value);
        copied.classList.remove('hidden');
        setTimeout(() => copied.classList.add('hidden'), 1200);
      } catch (e) { alert('Copy failed'); }
    });

    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([output.value || ''], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const date = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `transcript-${date}.txt`;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    });
  </script>
</body>
</html>
