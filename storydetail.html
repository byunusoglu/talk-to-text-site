<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Story ‚Äî Read with Sounds (Beta) | StoryBuds</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Inter:wght@400;600&family=Alegreya:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <script defer src="script.js"></script>

  <style>
    /* === Local layout polish === */
    .detail-wrap { max-width: 980px; margin: 20px auto; padding: 0 16px; }
    .soundbar {
      position: sticky; top: 68px; z-index: 10;
      display: grid; grid-template-columns: 1fr auto auto auto; gap: 8px;
      align-items: center; background: rgba(255,255,255,0.9);
      border: 1px solid #eee9fb; border-radius: 14px; padding: 10px 12px;
      box-shadow: var(--shadow);
    }
    .soundbar .status { color: #3a3450; font-weight: 600; }
    .soundbar .hint   { color: var(--muted); font-size: 13px; }
    .sfx-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .sfx-row .btn { padding: 10px 14px; font-weight: 700; }
    .inline-field { display:flex; align-items:center; gap:8px; }
    .inline-field input[type="range"] { width: 160px; }
    .story-reader { margin-top: 16px; }
    .badge-beta { display:inline-block; margin-left:6px; font-size:12px; font-weight:800; padding:2px 8px; border-radius:999px; background:#fbf9ff; border:1px solid #eee9fb; color: var(--plum-dark); }

    /* === STT Debug Panel === */
    .stt-debug { margin-top:12px; border:1px solid #eee9fb; border-radius:14px; background:rgba(255,255,255,0.9); box-shadow:var(--shadow); padding:12px; }
    .stt-controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .stt-panels { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .stt-panel { display:flex; flex-direction:column; gap:6px; }
    .stt-title { font-weight:700; color:#3a3450; font-size:14px; }
    .stt-box { min-height:80px; padding:10px; border:1px solid #eee9fb; border-radius:10px; background:#fff; overflow:auto; }
    .monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap; }
    .stt-meter-row { display:flex; align-items:center; gap:12px; margin-top:10px; }
    .stt-meter { flex:1; height:10px; background:#f2f2f6; border-radius:999px; overflow:hidden; border:1px solid #eee9fb; }
    .stt-meter span { display:block; height:100%; width:0%; background:#8E44EC; transition: width .08s linear; }
    @media (max-width:900px){ .soundbar{ grid-template-columns:1fr; } .stt-panels{ grid-template-columns:1fr; } }
  </style>
</head>

<body class="fade-in">
  <header class="topbar">
    <a href="index.html" class="logo">
      <span class="logo-badge"><img src="logo.png" alt="StoryBuds logo" /></span>
    </a>
    <div class="top-actions">
      <button class="cart-btn" id="cartBtn" aria-label="Cart">
        <svg class="cart-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 3h2l3.6 9.59a1 1 0 0 0 .92.65H17a1 1 0 0 0 .96-.74L20 6H6"
                stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="9" cy="20" r="1" fill="currentColor"></circle>
          <circle cx="17" cy="20" r="1" fill="currentColor"></circle>
        </svg>
        <span class="cart-count" id="cartCount">0</span>
      </button>
      <button class="hamburger" id="menuBtn" aria-label="Menu">‚ò∞</button>
    </div>
    <nav id="menu" class="menu hidden" aria-label="Main navigation">
      <a href="home.html">Home</a>
      <a href="create.html">Create Stories</a>
      <a href="#">My Profile</a>
    </nav>
  </header>

  <main class="detail-wrap">
    <h1>Read with Sounds <span class="badge-beta">Beta</span></h1>

    <section class="soundbar">
      <div>
        <div class="status" id="micStatus">Microphone: off</div>
        <div class="hint" id="micHint">Tap ‚ÄúStart listening‚Äù and read the story aloud.</div>
        <div class="sfx-row" id="manualSfx">
          <button class="btn ghost" data-sfx="whoosh">Whoosh</button>
          <button class="btn ghost" data-sfx="plip">Plip-plop</button>
          <button class="btn ghost" data-sfx="wind">Wind</button>
          <button class="btn ghost" data-sfx="chime">Magic chime</button>
          <button class="btn ghost" data-sfx="bark">Puppy bark</button>
          <button class="btn ghost" data-sfx="lullaby">Lullaby</button>
          <button class="btn ghost" data-sfx="stop">Stop ambience</button>
        </div>
      </div>

      <div class="inline-field">
        <label for="vol" class="muted">Volume</label>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.35" />
      </div>
      <div>
        <button class="btn" id="toggleMic">Start listening</button>
      </div>
    </section>

    <!-- üß† Speech-to-Text Debug Panel -->
    <section class="stt-debug" aria-label="Speech recognition debug">
      <div class="stt-controls">
        <div class="inline-field">
          <label for="sttLang" class="muted">Recognition language</label>
          <select id="sttLang">
            <option value="en-GB" selected>English (UK)</option>
            <option value="en-US">English (US)</option>
            <option value="tr-TR">T√ºrk√ße</option>
          </select>
        </div>
        <label class="muted"><input type="checkbox" id="sttInterimChk" checked /> Show interim</label>
        <button class="btn ghost" id="sttClear" type="button">Clear logs</button>
      </div>

      <div class="stt-panels">
        <div class="stt-panel"><div class="stt-title">Final transcript</div><div id="sttFinal" class="stt-box"></div></div>
        <div class="stt-panel"><div class="stt-title">Interim transcript</div><div id="sttInterim" class="stt-box"></div></div>
        <div class="stt-panel"><div class="stt-title">Events</div><div id="sttEvents" class="stt-box monospace"></div></div>
      </div>

      <div class="stt-meter-row">
        <div class="stt-title">Mic level</div>
        <div class="stt-meter"><span id="sttMeterBar"></span></div>
        <button class="btn ghost" id="sttMicTest" type="button">Start mic test</button>
      </div>
    </section>

    <section class="story-reader">
      <h2 id="storyTitle" class="sr-only">Your story</h2>
      <div id="storyContent" class="story-content"></div>
    </section>
  </main>

  <footer>¬© <span id="year"></span> StoryBuds</footer>

  <script>
    // === Setup: load story text ===
    const SS = window.sessionStorage;
    const storyEl = document.getElementById("storyContent");
    storyEl.innerHTML = SS.getItem("yw_story_html") || '<p class="muted">No story found.</p>';

    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const master = ctx.createGain(); master.gain.value = 0.35; master.connect(ctx.destination);
    document.getElementById('vol').addEventListener('input', e => { master.gain.value = parseFloat(e.target.value); });

    // === Tiny SFX ===
    function makeNoiseBuffer(){const b=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate);const d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*0.6;return b;}
    function playWhoosh(){const s=ctx.createBufferSource();s.buffer=makeNoiseBuffer();const f=ctx.createBiquadFilter();f.type="lowpass";f.frequency.value=15000;const g=ctx.createGain();g.gain.setValueAtTime(.0001,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.3,ctx.currentTime+.08);g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.6);s.connect(f).connect(g).connect(master);s.start();s.stop(ctx.currentTime+.65);}
    function playPlip(){const t=ctx.currentTime;[0,.18].forEach((d,i)=>{const o=ctx.createOscillator();o.type="sine";o.frequency.setValueAtTime(i?660:520,t+d);const g=ctx.createGain();g.gain.setValueAtTime(.0001,t+d);g.gain.exponentialRampToValueAtTime(.2,t+d+.02);g.gain.exponentialRampToValueAtTime(.0001,t+d+.25);o.connect(g).connect(master);o.start(t+d);o.stop(t+d+.26);});}
    function playChime(){const t=ctx.currentTime;[784,988,1319].forEach((f,i)=>{const o=ctx.createOscillator();o.type="triangle";o.frequency.setValueAtTime(f,t+i*.08);const g=ctx.createGain();g.gain.setValueAtTime(.0001,t+i*.08);g.gain.exponentialRampToValueAtTime(.22,t+i*.08+.04);g.gain.exponentialRampToValueAtTime(.0001,t+i*.08+.6);o.connect(g).connect(master);o.start(t+i*.08);o.stop(t+i*.08+.65);});}
    function playBark(){const t=ctx.currentTime;const o=ctx.createOscillator();o.type="square";o.frequency.setValueAtTime(220,t);const g=ctx.createGain();g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(.15,t+.02);g.gain.exponentialRampToValueAtTime(.0001,t+.2);o.connect(g).connect(master);o.start(t);o.stop(t+.21);}
    document.getElementById("manualSfx").addEventListener("click",e=>{
      const id=e.target.dataset.sfx;if(id==="whoosh")return playWhoosh();
      if(id==="plip")return playPlip();
      if(id==="chime")return playChime();
      if(id==="bark")return playBark();
    });

    // === Speech Recognition with Debug UI ===
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    const micBtn=document.getElementById("toggleMic"),micStatus=document.getElementById("micStatus");
    const langSel=document.getElementById("sttLang"),interimChk=document.getElementById("sttInterimChk");
    const boxFinal=document.getElementById("sttFinal"),boxInter=document.getElementById("sttInterim"),boxEv=document.getElementById("sttEvents");
    const btnClear=document.getElementById("sttClear");
    let rec=null,active=false;
    const logEv=m=>{boxEv.textContent+=`[${new Date().toLocaleTimeString()}] ${m}\n`;boxEv.scrollTop=boxEv.scrollHeight;};

    function startMic(){
      if(!SpeechRec){micStatus.textContent="SpeechRecognition not supported";return;}
      if(active)return;
      const lang=langSel.value;const showInterim=interimChk.checked;
      rec=new SpeechRec();rec.lang=lang;rec.continuous=true;rec.interimResults=showInterim;
      rec.onstart=()=>{active=true;micStatus.textContent=`Listening (${lang})`;micBtn.textContent="Stop listening";logEv("onstart");};
      rec.onresult=e=>{
        const r=e.results[e.results.length-1];
        if(!r)return;
        if(r.isFinal){
          const text=r[0].transcript.trim();
          boxFinal.textContent+=(boxFinal.textContent?'\n':'')+text;
          boxFinal.scrollTop=boxFinal.scrollHeight;
          boxInter.textContent='';
          logEv(`final: "${text}"`);
          const lower=text.toLowerCase();
          if(lower.includes("magic"))playChime();
          if(lower.includes("rain"))playPlip();
          if(lower.includes("dog"))playBark();
        } else if(showInterim){
          const interim=Array.from(e.results).filter(x=>!x.isFinal).map(x=>x[0].transcript).join(" ");
          boxInter.textContent=interim;
        }
      };
      rec.onerror=e=>logEv(`error: ${e.error}`);
      rec.onend=()=>{logEv("onend");if(active)try{rec.start();}catch{}};
      rec.start();
    }
    function stopMic(){active=false;try{rec&&rec.stop();}catch{};rec=null;micStatus.textContent="Microphone: off";micBtn.textContent="Start listening";}
    micBtn.addEventListener("click",()=>active?stopMic():startMic());
    btnClear.addEventListener("click",()=>{boxFinal.textContent='';boxInter.textContent='';boxEv.textContent='';});

    // Mic level test
    const meterBar=document.getElementById("sttMeterBar");
    document.getElementById("sttMicTest").addEventListener("click",async()=>{
      try{
        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        const src=ctx.createMediaStreamSource(stream);
        const analyser=ctx.createAnalyser();analyser.fftSize=512;src.connect(analyser);
        const data=new Uint8Array(analyser.fftSize);
        (function loop(){analyser.getByteTimeDomainData(data);let sum=0;for(let i=0;i<data.length;i++){const d=data[i]-128;sum+=d*d;}const rms=Math.sqrt(sum/data.length);const pct=Math.min(100,(rms/35)*100);meterBar.style.width=pct.toFixed(0)+"%";requestAnimationFrame(loop);})();logEv("Mic test running");
      }catch(err){logEv("Mic test error: "+err.message);}
    });

    // Resume context once on first click
    document.body.addEventListener("click",()=>ctx.resume&&ctx.resume(),{once:true});
    document.getElementById("year").textContent=new Date().getFullYear();
  </script>
</body>
</html>
