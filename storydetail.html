<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Story ‚Äî Read with Sounds (Beta) | StoryBuds</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Inter:wght@400;600&family=Alegreya:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="script.js"></script>

  <style>
    /* === Local layout polish (kept) === */
    .detail-wrap { max-width: 980px; margin: 20px auto; padding: 0 16px; }
    .soundbar {
      position: sticky; top: 68px; z-index: 10;
      display: grid; grid-template-columns: 1fr auto auto auto; gap: 8px;
      align-items: center; background: rgba(255,255,255,0.9);
      border: 1px solid #eee9fb; border-radius: 14px; padding: 10px 12px;
      box-shadow: var(--shadow);
    }
    .soundbar .status { color: #3a3450; font-weight: 600; }
    .soundbar .hint   { color: var(--muted); font-size: 13px; }
    .sfx-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .sfx-row .btn { padding: 10px 14px; font-weight: 700; }
    .inline-field { display:flex; align-items:center; gap:8px; }
    .inline-field input[type="range"] { width: 160px; }
    .story-reader { margin-top: 16px; }
    .badge-beta { display:inline-block; margin-left:6px; font-size:12px; font-weight:800; padding:2px 8px; border-radius:999px; background:#fbf9ff; border:1px solid #eee9fb; color: var(--plum-dark); }

    /* === STT Debug Panel === */
    .stt-debug { margin-top:12px; border:1px solid #eee9fb; border-radius:14px; background:rgba(255,255,255,0.9); box-shadow:var(--shadow); padding:12px; }
    .stt-controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .stt-panels { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .stt-panel { display:flex; flex-direction:column; gap:6px; }
    .stt-title { font-weight:700; color:#3a3450; font-size:14px; }
    .stt-box { min-height:80px; padding:10px; border:1px solid #eee9fb; border-radius:10px; background:#fff; overflow:auto; }
    .monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap; }
    .stt-meter-row { display:flex; align-items:center; gap:12px; margin-top:10px; }
    .stt-meter { flex:1; height:10px; background:#f2f2f6; border-radius:999px; overflow:hidden; border:1px solid #eee9fb; }
    .stt-meter span { display:block; height:100%; width:0%; background:#8E44EC; transition: width .08s linear; }

    /* Hide heavy UI by default ‚Äî "production mode" */
    .dev-only { display: none !important; }

    /* Sticky single CTA for production */
    .sticky-listen {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 18px;
      z-index: 20;
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      font-weight: 800;
    }

    /* Short helper hint under title */
    .listen-hint {
      color: var(--muted);
      font-size: 13px;
      margin: 6px 0 0;
      text-align: center;
    }

    @media (max-width:900px){
      .soundbar{ grid-template-columns:1fr; }
      .stt-panels{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body class="fade-in">
  <!-- Topbar -->
  <header class="topbar">
    <a href="index.html" class="logo">
      <span class="logo-badge"><img src="logo.png" alt="StoryBuds logo" /></span>
    </a>
    <div class="top-actions">
      <button class="cart-btn" id="cartBtn" aria-label="Cart">
        <svg class="cart-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 3h2l3.6 9.59a1 1 0 0 0 .92.65H17a1 1 0 0 0 .96-.74L20 6H6"
                stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="9" cy="20" r="1" fill="currentColor"></circle>
          <circle cx="17" cy="20" r="1" fill="currentColor"></circle>
        </svg>
        <span class="cart-count" id="cartCount">0</span>
      </button>
      <button class="hamburger" id="menuBtn" aria-label="Menu">‚ò∞</button>
      <button id="favBtn" aria-pressed="false" title="Star this story">‚≠ê Favourite</button>
    </div>
    <nav id="menu" class="menu hidden" aria-label="Main navigation">
      <a href="home.html">Home</a>
      <a href="create.html">Create Stories</a>
      <a href="#">My Profile</a>
    </nav>
  </header>

  <main class="detail-wrap">
    <h1>Read with Sounds <span class="badge-beta">Beta</span></h1>
    <p class="listen-hint">Tap ‚ÄúPlay story‚Äù to hear the narration in your chosen voice.</p>

    <!-- ‚úÖ Production CTA: the only visible control by default -->
    <button class="btn ghost" id="voiceBtn">üéôÔ∏è Voice</button>
    <button class="btn sticky-listen" id="toggleMic">‚ñ∂Ô∏è Play story</button>

    <!-- Story -->
    <section class="story-reader">
      <h2 id="storyTitle" class="sr-only">Your story</h2>
      <div id="storyContent" class="story-content"></div>
    </section>
  </main>

  <footer>¬© <span id="year"></span> StoryBuds</footer>

  <script>
    /* =======================
       Load story + audio base
    ======================= */
    const SS = window.sessionStorage;
    const storyEl = document.getElementById("storyContent");
    storyEl.innerHTML = SS.getItem("yw_story_html") || '<p class="muted">No story found. Please generate a story first.</p>';

    // Fallback: if no local story and user is signed in, fetch latest from partner API
(async () => {
  try {
    const hasLocal = !!SS.getItem('yw_story_html');
    if (hasLocal) return;

    // Check auth ‚Äî /users/me
    const me = await fetch('https://imaginee-y9nk.onrender.com/api/v1/users/me', {
      credentials: 'include'
    });
    if (!me.ok) return; // not signed in ‚Üí keep default message

    // Get user's stories ‚Äî /stories/my
    const res = await fetch('https://imaginee-y9nk.onrender.com/api/v1/stories/my', {
      credentials: 'include'
    });
    if (!res.ok) return;

    const data = await res.json();
    const stories = data?.data?.stories || [];
    if (!stories.length) return;

    // Most recent story first
    const latest = stories.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt))[0];

    // If pages included, render; else fetch by id ‚Äî /stories/:id
    let html = '';
    if (latest.pages?.length) {
      const body = latest.pages.map(p => `<p>${(p?.text || '').trim()}</p>`).join('');
      html = `<h1>${latest.title || ''}</h1>${body}`;
    } else if (latest._id) {
      const one = await fetch(`https://imaginee-y9nk.onrender.com/api/v1/stories/${latest._id}`, {
        credentials: 'include'
      });
      if (one.ok) {
        const full = (await one.json())?.data?.story || {};
        const body = (full.pages || []).map(p => `<p>${(p?.text || '').trim()}</p>`).join('');
        html = `<h1>${full.title || latest.title || ''}</h1>${body}`;
      }
    }

    if (html) {
      SS.setItem('yw_story_html', html);
      storyEl.innerHTML = html;
    }
  } catch (_) {
    // silent fail to keep UX clean
  }
})();
    
    // Show full controls in ?debug=1 mode
    const url = new URL(location.href);
    const isDebug = url.searchParams.get("debug") === "1";
    if (isDebug) {
      document.getElementById('soundbar')?.classList.remove('dev-only');
      document.getElementById('sttDebug')?.classList.remove('dev-only');
      // Nudge sticky CTA a bit higher when debug bars appear
      document.getElementById('toggleMic')?.style.setProperty('bottom','88px');
    }

    // Audio & ambience disabled for now
const ctx = null;


    // Manual SFX (exists in DOM but hidden by default)
    (function(){
      const row = document.getElementById("manualSfx");
      if (!row) return;
      row.addEventListener("click", (e) => {
        const id = e.target.closest('[data-sfx]')?.dataset.sfx; if (!id) return;
        if (id === "whoosh")  return playWhoosh();
        if (id === "plip")    return playPlip();
        if (id === "chime")   return playChime();
        if (id === "bark")    return playBarkSoft();
        if (id === "wind")    return playWindGust();
        if (id === "lullaby") return playLullabyPhrase();
        if (id === "stop")    return stopAmbience();
      });
    })();

    /* ====== Ambience (auto + crossfade) ====== */
    let amb = { node: null, gain: null, kind: 'off' };

    function makeNoiseLoop(color='white'){
      const src = ctx.createBufferSource();
      const b = ctx.createBuffer(1, ctx.sampleRate * 2, ctx.sampleRate);
      const d = b.getChannelData(0);
      for (let i=0;i<d.length;i++){
        const white = Math.random()*2-1;
        d[i] = color === 'ocean' ? ((d[i-1]||0)*0.98 + white*0.02)
             : color === 'rain'  ? white*0.35
             : white*0.22;
      }
      src.buffer = b; src.loop = true;
      return src;
    }
    function makePad(freqs=[220, 277, 330]){
      const g = ctx.createGain(); g.gain.value = 0.0;
      freqs.forEach((f,i) => {
        const o = ctx.createOscillator(); o.type = 'sine';
        o.frequency.setValueAtTime(f, ctx.currentTime + i*0.03);
        const og = ctx.createGain(); og.gain.value = 0.06;
        o.connect(og).connect(g); o.start();
      });
      return { node: g, gain: g };
    }
    function startAmbience(kind){
      stopAmbience(0.5);
      let node=null, gain=null;
      if (kind === 'forest'){
        const s = makeNoiseLoop('white'); const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=900;
        const g = ctx.createGain(); g.gain.value = 0.0; s.connect(lp).connect(g).connect(master); s.start(); node=s; gain=g;
      } else if (kind === 'ocean'){
        const s = makeNoiseLoop('ocean'); const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=200; bp.Q.value=0.7;
        const g = ctx.createGain(); g.gain.value = 0.0; s.connect(bp).connect(g).connect(master); s.start(); node=s; gain=g;
      } else if (kind === 'rain'){
        const s = makeNoiseLoop('rain'); const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1800;
        const g = ctx.createGain(); g.gain.value = 0.0; s.connect(lp).connect(g).connect(master); s.start(); node=s; gain=g;
      } else if (kind === 'night'){
        const p = makePad([261.6, 329.6, 392.0]); p.node.connect(master); node=p.node; gain=p.gain;
      } else if (kind === 'castle'){
        const p = makePad([329.6, 415.3, 523.3]); p.node.connect(master); node=p.node; gain=p.gain;
      } else if (kind === 'pad'){
        const p = makePad([220, 277, 330]); p.node.connect(master); node=p.node; gain=p.gain;
      }
      if (gain){
        const t = ctx.currentTime;
        gain.gain.cancelScheduledValues(t);
        gain.gain.linearRampToValueAtTime(0.0, t);
        gain.gain.linearRampToValueAtTime(0.14, t + 0.8);
      }
      amb = { node, gain, kind };
    }
    function stopAmbience(fade=0.3){
      if (!amb.gain){ amb = { node:null, gain:null, kind:'off' }; return; }
      const t = ctx.currentTime;
      amb.gain.gain.cancelScheduledValues(t);
      amb.gain.gain.linearRampToValueAtTime(0, t + fade);
      if (amb.node && amb.node.stop) amb.node.stop(t + fade + 0.05);
      amb = { node:null, gain:null, kind:'off' };
    }

    const ambSel = document.getElementById('amb');
    function pickAmbienceFromStory(text){
      const s = deaccent(text || '');
      if (/\brain|storm|puddle/.test(s)) return 'rain';
      if (/\bocean|sea|wave|beach/.test(s)) return 'ocean';
      if (/\bforest|woods|tree|owl/.test(s)) return 'forest';
      if (/\bnight|moon|sleep|star/.test(s)) return 'night';
      if (/\bcastle|king|queen|magic/.test(s)) return 'castle';
      return 'pad';
    }
    function applyAmbienceSelection(val){
      if (val === 'off') return stopAmbience(0.4);
      if (val === 'auto') return startAmbience(pickAmbienceFromStory(storyEl.textContent || ''));
      startAmbience(val);
    }
    const storedAmb = SS.getItem("yw_ambience") || "auto";
    if (ambSel) {
      ambSel.value = storedAmb;
      applyAmbienceSelection(ambSel.value);
      ambSel.addEventListener('change', e => {
        const v = e.target.value;
        SS.setItem("yw_ambience", v);
        applyAmbienceSelection(v);
      });
    } else {
      applyAmbienceSelection(storedAmb);
    }

    /* ==========================================
       Option 1: Story follower + prefix trigger
       ========================================== */
    const RAW_TEXT = (storyEl.textContent || "")
      .toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/[^a-z0-9\s']/g,' ')
      .replace(/\s+/g,' ')
      .trim();

    const TRIGGERS = new Set(['magic','sparkle','rain','wind','dog','puppy','star','sleep','fly']);
    const EFFECT_FOR = {
      magic:'chime', sparkle:'chime', star:'chime',
      rain:'plip', wind:'wind', dog:'bark', puppy:'bark',
      sleep:'lullaby', fly:'whoosh'
    };

    const TOKENS = RAW_TEXT ? RAW_TEXT.split(' ') : [];
    let cursor = 0;
    const MIN_PREFIX = (w) => Math.min(3, Math.max(2, Math.floor(w.length * 0.35)));

    let lastEffectAt = 0;
    const COOLDOWN_GLOBAL_MS = 380;
    const lastAtByEffect = Object.create(null);
    function canTrigger(effectName, cdMs){
      const now = Date.now();
      if (now - lastEffectAt < COOLDOWN_GLOBAL_MS) return false;
      const last = lastAtByEffect[effectName] || 0;
      if (now - last < cdMs) return false;
      lastAtByEffect[effectName] = now;
      lastEffectAt = now;
      return true;
    }
    const EFFECTS = {
      whoosh: { fn: playWhoosh,       cd: 1600 },
      plip:   { fn: playPlip,         cd: 1600 },
      wind:   { fn: playWindGust,     cd: 5000 },
      chime:  { fn: playChime,        cd: 2500 },
      bark:   { fn: playBarkSoft,     cd: 2200 },
      lullaby:{ fn: playLullabyPhrase,cd: 7000 },
    };
    function triggerEffect(name){
      const eff = EFFECTS[name];
      if (!eff) return;
      if (canTrigger(name, eff.cd)) eff.fn();
    }

    function alignAndMaybeTrigger(interimTail) {
      if (!TOKENS.length) return;
      const words = interimTail.toLowerCase().split(/\s+/).filter(Boolean).slice(-12);
      if (!words.length) return;

      const WINDOW = 30;
      let bestIdx = cursor, bestHit = 0;
      const start = Math.max(0, cursor - WINDOW);
      const end   = Math.min(TOKENS.length, cursor + WINDOW);

      for (let i = start; i < end; i++) {
        const sliceStart = Math.max(0, i - words.length + 1);
        const slice = TOKENS.slice(sliceStart, i + 1);
        let hit = 0;
        const offset = Math.max(0, words.length - slice.length);
        for (let k = 0; k < slice.length; k++) if (slice[k] === words[offset + k]) hit++;
        if (hit > bestHit) { bestHit = hit; bestIdx = i; }
      }

      if (bestIdx > cursor) cursor = Math.min(bestIdx, cursor + 3);

      for (let j = cursor; j < Math.min(cursor + 20, TOKENS.length); j++) {
        const w = TOKENS[j];
        if (!TRIGGERS.has(w)) continue;

        const need   = MIN_PREFIX(w);
        const prefix = w.slice(0, need);
        const lastWord = words[words.length - 1] || '';

        if (lastWord.startsWith(prefix)) {
          const eff = EFFECT_FOR[w];
          if (eff) triggerEffect(eff);
          cursor = Math.min(j + 1, TOKENS.length - 1);
          break;
        }
        if (j - cursor > 8) break;
      }
    }



    (function(){
      const clearBtn = document.getElementById("sttClear");
      if (!clearBtn) return;
      clearBtn.addEventListener("click", () => {
        const boxFinal  = document.getElementById('sttFinal');
        const boxInter  = document.getElementById('sttInterim');
        const boxEv     = document.getElementById('sttEvents');
        if (boxFinal) boxFinal.textContent='';
        if (boxInter) boxInter.textContent='';
        if (boxEv)    boxEv.textContent='';
      });
    })();


    // Footer year
const yearEl = document.getElementById("year");
if (yearEl) yearEl.textContent = String(new Date().getFullYear());
  </script>
  <script>
/* 1) Optional: hydrate page <h1> from story */
(function(){
  const storyH1 = document.getElementById('storyContent')?.querySelector('h1')?.textContent?.trim();
  const pageH1  = document.querySelector('main h1, .detail-wrap h1');
  if (storyH1 && pageH1 && !/Read with Sounds/i.test(pageH1.textContent)) pageH1.textContent = storyH1;
})();

/* 2) Favourites (local only) */
(function(){
  const key='yw_starred_stories', btn=document.getElementById('favBtn'); if(!btn) return;
  const get=()=>{try{return JSON.parse(localStorage.getItem(key)||'[]')}catch(_){return[]}};
  const set=a=>{try{localStorage.setItem(key,JSON.stringify(a))}catch(_){}};
  const title=(document.getElementById('storyContent')?.querySelector('h1')?.textContent?.trim()
               || document.querySelector('main h1, .detail-wrap h1')?.textContent?.trim()
               || 'Untitled Story');
  const paint=()=>{const on=get().includes(title); btn.setAttribute('aria-pressed',on?'true':'false'); btn.textContent=on?'üåü Favourited':'‚≠ê Favourite';};
  const toast=m=>{const n=document.createElement('div'); n.textContent=m; n.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:110px;background:#1a1f2e;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.2);z-index:999'; document.body.appendChild(n); setTimeout(()=>n.remove(),1100);};
  btn.addEventListener('click',()=>{const a=get(); const i=a.indexOf(title); if(i>=0)a.splice(i,1); else a.push(title); set(a); paint(); toast(a.includes(title)?'Saved to favourites':'Removed from favourites');});
  paint();
})();

/* 3) Parent voice (teaser) */
document.getElementById('voiceBtn')?.addEventListener('click', ()=>{
  alert('üéôÔ∏è Parent voice is coming soon.\nRecord a 20-second sample and we‚Äôll narrate in your voice.');
});
</script>
</body>
</html>
